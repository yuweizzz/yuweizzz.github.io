<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://yuweizzz.github.io/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/github.min.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/github-style.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/light.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/dark.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/syntax.css' />
    <title>PowerDNS 调优 - Wei&#39;s blog</title>
    
    <link rel="icon" type="image/x-icon" href='/images/github.png'>
    
    <meta name="theme-color" content="#1e2327">

    
    <meta name="description"
  content="这篇笔记用来记录 PowerDNS 的性能优化。
" />
<meta name="keywords"
  content='blog, google analytics' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://yuweizzz.github.io/post/powerdns_performance_guide/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="PowerDNS 调优 - Wei&#39;s blog" />
<meta name="twitter:description"
  content="这篇笔记用来记录 PowerDNS 的性能优化。
" />
<meta name="twitter:site" content="https://yuweizzz.github.io" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://yuweizzz.github.io">


<meta property="og:type" content="article" />
<meta property="og:title" content="PowerDNS 调优 - Wei&#39;s blog">
<meta property="og:description"
  content="这篇笔记用来记录 PowerDNS 的性能优化。
" />
<meta property="og:url" content="https://yuweizzz.github.io/post/powerdns_performance_guide/" />
<meta property="og:site_name" content="PowerDNS 调优" />
<meta property="og:image"
  content="https://yuweizzz.github.io">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2022-03-12 10:22:45 &#43;0000 UTC" />











<script async src="https://www.googletagmanager.com/gtag/js?id=UA-174929827-1"></script>
<script>
  if (navigator.doNotTrack !== '1') {
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-174929827-1');
  }
</script>


</head>

<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://yuweizzz.github.io">
        <svg class="octicon" height="32" viewBox="0 0 16 16" version="1.1" width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd"
            d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          <form target="_blank" action="https://www.google.com/search" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
              <input type="hidden" name="q" value="site:https://yuweizzz.github.io">
            </label>
          </form>
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://yuweizzz.github.io">
        <svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" version="1.1"
          width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>
  
<div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://yuweizzz.github.io">
                  <img class=" avatar-user"
                    src="https://yuweizzz.github.io/images/avatar.png"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://yuweizzz.github.io">Wei</a></span><span
                    class="path-divider">/</span><strong class="css-truncate-target mr-1" style="max-width: 410px"><a
                      href="https://yuweizzz.github.io/post/powerdns_performance_guide/">PowerDNS 调优</a></strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Sat, 12 Mar 2022 10:22:45 &#43;0000"
                    class="no-wrap">
                    Sat, 12 Mar 2022 10:22:45 &#43;0000</relative-time>

                  
                  <span class="file-info-divider"></span>
                  Modified <relative-time datetime="Fri, 19 Apr 2024 08:37:27 &#43;0000"
                    class="no-wrap">
                    Fri, 19 Apr 2024 08:37:27 &#43;0000</relative-time>
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div id="post-header" class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style="z-index: 2">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    
                    <summary id="toc-toggle" onclick="clickToc()" class="btn btn-octicon m-0 mr-2 p-2">
                      <svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered">
                        <path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zM3 8a1 1 0 11-2 0 1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"></path>
                      </svg>
                    </summary>
                    <details-menu class="SelectMenu" id="toc-details" style="display: none;">
                      <div class="SelectMenu-modal rounded-3 mt-1" style="max-height: 340px;">
                        <div class="SelectMenu-list SelectMenu-list--borderless p-2" style="overscroll-behavior: contain;" id="toc-list">
                        </div>
                      </div>
                    </details-menu>
                      2653 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                    
                    <a class="muted-link mr-3" href="/tags/linux">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      Linux
                    </a>
                    
                    <a class="muted-link mr-3" href="/tags/dns">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      DNS
                    </a>
                    
                    <a class="muted-link mr-3" href="/tags/powerdns">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      PowerDNS
                    </a>
                    
                    <a class="muted-link mr-3" href="/tags/lua">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      Lua
                    </a>
                    
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5" style="z-index: 1">
                <article class="markdown-body entry-content container-lg"><p>这篇笔记用来记录 PowerDNS 的性能优化。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">
                                       <span class="o">(</span>@@<span class="o">)</span> <span class="o">(</span>  <span class="o">)</span> <span class="o">(</span>@<span class="o">)</span>  <span class="o">(</span> <span class="o">)</span>  @@    <span class="o">()</span>    @     O     @     O      @
                                  <span class="o">(</span>   <span class="o">)</span>
                              <span class="o">(</span>@@@@<span class="o">)</span>
                           <span class="o">(</span>    <span class="o">)</span>

                         <span class="o">(</span>@@@<span class="o">)</span>
                       <span class="o">====</span>        ________                ___________
                   _D _<span class="p">|</span>  <span class="p">|</span>_______/        <span class="se">\_</span>_I_I_____<span class="o">===</span>__<span class="p">|</span>_________<span class="p">|</span>
                    <span class="p">|</span><span class="o">(</span>_<span class="o">)</span>---  <span class="p">|</span>   H<span class="se">\_</span>_______/ <span class="p">|</span>   <span class="p">|</span>        <span class="o">=</span><span class="p">|</span>___ ___<span class="p">|</span>      _________________
                    /     <span class="p">|</span>  <span class="p">|</span>   H  <span class="p">|</span>  <span class="p">|</span>     <span class="p">|</span>   <span class="p">|</span>         <span class="o">||</span>_<span class="p">|</span> <span class="p">|</span>_<span class="o">||</span>     _<span class="p">|</span>                <span class="se">\_</span>____A
                   <span class="p">|</span>      <span class="p">|</span>  <span class="p">|</span>   H  <span class="p">|</span>__--------------------<span class="p">|</span> <span class="o">[</span>___<span class="o">]</span> <span class="p">|</span>   <span class="o">=</span><span class="p">|</span>                        <span class="p">|</span>
                   <span class="p">|</span> ________<span class="p">|</span>___H__/__<span class="p">|</span>_____/<span class="o">[][]</span>~<span class="se">\_</span>______<span class="p">|</span>       <span class="p">|</span>   -<span class="p">|</span>                        <span class="p">|</span>
                   <span class="p">|</span>/ <span class="p">|</span>   <span class="p">|</span>-----------I_____I <span class="o">[][]</span> <span class="o">[]</span>  D   <span class="p">|</span><span class="o">=======</span><span class="p">|</span>____<span class="p">|</span>________________________<span class="p">|</span>_
                 __/ <span class="o">=</span><span class="p">|</span> o <span class="p">|</span><span class="o">=</span>-~O<span class="o">=====</span><span class="nv">O</span><span class="o">=====</span><span class="nv">O</span><span class="o">=====</span>O<span class="se">\ </span>____Y___________<span class="p">|</span>__<span class="p">|</span>__________________________<span class="p">|</span>_
                  <span class="p">|</span>/-<span class="o">=</span><span class="p">|</span>___<span class="p">|</span><span class="o">=</span>    <span class="o">||</span>    <span class="o">||</span>    <span class="o">||</span>    <span class="p">|</span>_____/~<span class="se">\_</span>__/          <span class="p">|</span>_D__D__D_<span class="p">|</span>  <span class="p">|</span>_D__D__D_<span class="p">|</span>
                   <span class="se">\_</span>/      <span class="se">\_</span>_/  <span class="se">\_</span>_/  <span class="se">\_</span>_/  <span class="se">\_</span>_/      <span class="se">\_</span>/               <span class="se">\_</span>/   <span class="se">\_</span>/    <span class="se">\_</span>/   <span class="se">\_</span>/

</code></pre></div><h2 id="powerdns-的特点">PowerDNS 的特点</h2>
<p>PowerDNS 和 BIND 一样，都是 DNS 服务软件。</p>
<p>PowerDNS 比较大的特色在于它把权威解析和递归解析的能力拆解开来分为两个服务，负责权威解析的是 pdns authoritative server ，负责递归解析的是 pdns recursor server 。我认为这种拆解是有利的，它将不同的解析流量区分，排查问题时会更方便，对后续的性能瓶颈分析也是有利的。</p>
<p>PowerDNS 支持各种各样的后端，可以是文件系统，也可以是通用关系型数据库，虽然 BIND 可以通过 DLZ 来实现关系型数据库作为记录的存储后端，但从支持的后端多样性来看，明显是 PowerDNS 更丰富。</p>
<p>PowerDNS 内置 Web Server 实现了 API 支持和监控系统，可以进行实时数据监控和动态更新记录，而 BIND 虽然也有相关的统计信息输出，但是这部分功能明显逊色于 PowerDNS 。</p>
<p>PowerDNS 的搭建和配置都相对简单，这里只记录一些调优过程的思考。</p>
<h2 id="authoritative-server-的性能调优">Authoritative Server 的性能调优</h2>
<p>我们需要先了解 Authoritative Server 中重要的缓存种类：</p>
<ul>
<li>Packet Cache ：数据包缓存，可以无需做任何额外处理，直接响应查询请求的数据缓存。</li>
<li>Query Cache ：执行后端查询后，后端查询到的数据库记录缓存。</li>
<li>Negative Cache ：在 Query Cache 中，请求信息无法在后端查询到记录的数据缓存。</li>
</ul>
<p>其实可以直接地认为是两种缓存， Packet Cache 是对请求回答数据的缓存， Query Cache 和 Negative Cache 都是对数据库记录的缓存，通常我们希望直接返回 Packet Cache ，这会是最快最节省资源的响应办法。如果确实无法直接命中，则应该优先在 Query Cache 部分寻找命中，可以节省对数据库的查询行为。在这一部分， Negative Cache 和常规 Query Cache 的命中都是同样的，只是这个请求是否能得到回答数据的区别而已。</p>
<p>关于缓存部分，性能优化的调节点是在于缓存时间和缓存条数，我们可以把默认的 Packet Cache 的缓存时间略微提高一些，它在配置文件中以 cache-ttl 出现，默认时间为 20s ，这个值可以调高至 60s 。</p>
<p>Query Cache 的缓存时间在配置文件中以 query-cache-ttl 出现，默认时间为 20s ，这个值也可以和 cache-ttl 一样调高到 60s 。</p>
<p>Negative Cache 的缓存时间在配置文件中以 negquery-cache-ttl 出现，默认时间为 60s ，由于它和 Query Cache 类似，可以保持和 query-cache-ttl 一致的 60s 。</p>
<p>要注意调节缓存时间能起到性能优化的前提是使用关系型数据库作为后端，如果是文件系统或者是基于内存的后端存储，这些缓存时间需要额外考量，甚至可以直接禁用缓存，因为它们的响应速度足够快，缓存反而会成为性能的拖累。</p>
<p>另一个性能优化的调节点在于对工作线程的调节，在 Authoritative Server 中有 receiver thread 和 distributor thread 的概念。</p>
<p>receiver thread 是用于接收请求的线程，它的线程数可以自由调节，但要达到优化性能，这个数量应该适中，最好是和 CPU 数量成倍数关系。它在配置中以 receiver-threads 出现，默认值是 1 。</p>
<p>distributor thread 是 receiver thread 接收请求后，用于处理这些请求的线程，主要担任查询工作。它在配置中以 distributor-threads 出现，默认值是 3 。</p>
<p>需要注意的是这里 distributor-threads 是每个 receiver thread 所关联的线程数量，也就是说一个 receiver thread 可以对应一个或多个 distributor thread ，这个值应该由使用的后端类型决定，如果只有单个关系型数据库作为后端，那么 distributor-threads 为 1 应该是最优的做法，但如果使用了多个后端数据库，设置较大的 distributor-threads 可以得到更好的性能。</p>
<p>然后是配置中的 reuseport 这个特性开关，它是通过启用内核的 SO_REUSEPORT 选项来使得多个套接字可以在同个端口监听，如果内核版本过低不支持 SO_REUSEPORT ，那么不管这个选项如何设置，它都是默认关闭的。</p>
<p>设置多个 receiver thread 和开启 reuseport 的两者组合应该是最佳性能的工作方式，这样内核会将请求均衡到各个 receiver thread 中，获取比较好的性能表现。</p>
<p>最终的优化配置大概如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 假设是 4 核机器，单个 MySQL 作为 backend</span>
$ cat pdns.conf
cache-ttl<span class="o">=</span><span class="m">60</span>
query-cache-ttl<span class="o">=</span><span class="m">60</span>
negquery-cache-ttl<span class="o">=</span><span class="m">60</span>
distributor-threads<span class="o">=</span><span class="m">1</span>
receiver-threads<span class="o">=</span><span class="m">4</span>
<span class="nv">reuseport</span><span class="o">=</span>yes
</code></pre></div><h2 id="recursor-server-的性能调优">Recursor Server 的性能调优</h2>
<p>Recursor Server 同样有着多个缓存种类：</p>
<ul>
<li>Nameserver Speeds Cache ：对所有远端权威服务器的平均延迟时间的缓存。</li>
<li>Negative Cache ：对无响应数据请求的缓存。</li>
<li>Recursor Cache ：对递归过程一些公共记录信息的缓存。</li>
<li>Packet Cache ：数据包缓存，可以无需做任何额外处理，直接响应查询请求的数据缓存。</li>
</ul>
<p>在递归服务器中，各类缓存的 ttl 已经被默认设置为较高值，所以这部分并没有对它们做额外调节，更多的优化细节在于工作线程这一方面。</p>
<p>Recursor Server 的 threads 和 Authoritative Server 的 receiver threads 类似，是处理具体请求的线程，但它不负责具体的后端查询工作。</p>
<p>但在 Recursor Server 中还是有 distributor thread 的概念，它负责将请求分发到 thread 中，按照官方的说法，使用 distributor thread 可以提高缓存的命中率。但以实际测试情况来看，在原有 Packet Cache 命中率就很高的情况下，开启 distributor thread 会导致实际工作的 thread 负载不均衡，而缓存命中率只是略有提高。</p>
<p>所以实际使用中，较好的做法是禁用 distributor thread 和开启 reuseport 特性，由内核去把请求分配到 thread 中，并且使用 cpu-map 来把 thread 和具体的 CPU 绑定，有助于缓存的就近访问，提高响应的速度。</p>
<p>最终的优化配置大概如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 假设是 4 核机器，单个 MySQL 作为 backend</span>
$ cat pdns.conf
<span class="nv">threads</span><span class="o">=</span><span class="m">4</span>
pdns-distributes-queries<span class="o">=</span>no
<span class="nv">reuseport</span><span class="o">=</span>yes
cpu-map<span class="o">=</span><span class="nv">0</span><span class="o">=</span><span class="m">0</span> <span class="nv">1</span><span class="o">=</span><span class="m">1</span> <span class="nv">2</span><span class="o">=</span><span class="m">2</span> <span class="nv">3</span><span class="o">=</span><span class="m">3</span>
</code></pre></div><h2 id="recursor-server-的-lua-扩展">Recursor Server 的 lua 扩展</h2>
<p>powerdns 可以通过 lua 扩展脚本在查询的基础上实现更复杂的功能。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 添加 lua 脚本扩展</span>
$ cat pdns.conf
lua-dns-script /path/to/lua/script

<span class="c1"># 动态重载 lua 脚本</span>
rec_control reload-lua-script
</code></pre></div><p>powerdns 提供了多个查询钩子，可以在对应的查询阶段进行请求拦截并重写对应的回答动作，有以下几个钩子：</p>
<ul>
<li>ipfilter ：在查询数据包开始解析之前。</li>
<li>gettag ：在查询数据包缓存之前。</li>
<li>prerpz ：在应用响应策略之前。</li>
<li>preresolve ：在查询逻辑工作开始之前。</li>
<li>nodata, nxdomain ：在返回无数据结果和无域名结果之后。</li>
<li>postresolve ：在查询逻辑工作结束之后。</li>
<li>preoutquery ：在向权威服务器查询之前。</li>
<li>policyEventFilter ：在响应策略命中之后。</li>
</ul>
<p>由于存在着多阶段的钩子函数，所以实现扩展功能只需要重写对应的函数即可。</p>
<p>以下是一些参考用例，更多详细用法可以参考官方文档。</p>
<div class="highlight"><pre class="chroma"><code class="language-lua" data-lang="lua"><span class="c1">-- 以无响应域名结果的钩子为例，来自官方实例</span>
<span class="n">nxdomainsuffix</span> <span class="o">=</span> <span class="n">newDN</span><span class="p">(</span><span class="s2">&#34;com&#34;</span><span class="p">)</span>
<span class="kr">function</span> <span class="nf">nxdomain</span><span class="p">(</span><span class="n">dq</span><span class="p">)</span>
    <span class="n">pdnslog</span><span class="p">(</span><span class="s2">&#34;nxdomain called for: &#34;</span><span class="o">..</span><span class="n">dq.qname</span><span class="p">:</span><span class="n">toString</span><span class="p">())</span>
    <span class="kr">if</span> <span class="n">dq.qname</span><span class="p">:</span><span class="n">isPartOf</span><span class="p">(</span><span class="n">nxdomainsuffix</span><span class="p">)</span> <span class="kr">then</span>
        <span class="n">dq.rcode</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1">-- 修改为正常应答</span>
        <span class="n">dq</span><span class="p">:</span><span class="n">addAnswer</span><span class="p">(</span><span class="n">pdns.CNAME</span><span class="p">,</span> <span class="s2">&#34;www.powerdns.org&#34;</span><span class="p">)</span>
        <span class="n">dq</span><span class="p">:</span><span class="n">addAnswer</span><span class="p">(</span><span class="n">pdns.A</span><span class="p">,</span> <span class="s2">&#34;1.2.3.4&#34;</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="s2">&#34;www.powerdns.org&#34;</span><span class="p">)</span>
        <span class="kr">return</span> <span class="kc">true</span>  <span class="c1">-- return true 说明这个钩子函数生效，如果 return false 则这个钩子函数不生效</span>
    <span class="kr">end</span>
    <span class="kr">return</span> <span class="kc">false</span>
<span class="kr">end</span>

<span class="c1">-- 以查询逻辑工作开始之前的钩子为例，由官方实例改写</span>
<span class="n">blockset</span> <span class="o">=</span> <span class="n">newDS</span><span class="p">()</span>
<span class="n">blockset</span><span class="p">:</span><span class="n">add</span><span class="p">{</span><span class="s2">&#34;powerdns.org&#34;</span><span class="p">,</span> <span class="s2">&#34;powerdns.com&#34;</span><span class="p">}</span>  <span class="c1">-- 以列表形式添加多个域名</span>
<span class="n">dropset</span> <span class="o">=</span> <span class="n">newDS</span><span class="p">()</span>
<span class="n">dropset</span><span class="p">:</span><span class="n">add</span><span class="p">(</span><span class="s2">&#34;pdns.org&#34;</span><span class="p">)</span>  <span class="c1">-- 添加单个域名</span>
<span class="kr">function</span> <span class="nf">preresolve</span><span class="p">(</span><span class="n">dq</span><span class="p">)</span>
    <span class="c1">-- 重写响应结果</span>
    <span class="kr">if</span> <span class="n">blockset</span><span class="p">:</span><span class="n">check</span><span class="p">(</span><span class="n">dq.qname</span><span class="p">)</span> <span class="kr">then</span>
        <span class="n">dq.variable</span> <span class="o">=</span> <span class="kc">true</span>      <span class="c1">-- disable packet cache in any case</span>
        <span class="kr">if</span> <span class="n">dq.qtype</span> <span class="o">==</span> <span class="n">pdns.A</span> <span class="kr">then</span>
            <span class="n">dq</span><span class="p">:</span><span class="n">addAnswer</span><span class="p">(</span><span class="n">pdns.A</span><span class="p">,</span> <span class="s2">&#34;1.2.3.4&#34;</span><span class="p">)</span>
            <span class="kr">return</span> <span class="kc">true</span>
        <span class="kr">end</span>
    <span class="kr">end</span>
    <span class="c1">-- 黑名单机制</span>
    <span class="kr">if</span> <span class="n">dropset</span><span class="p">:</span><span class="n">check</span><span class="p">(</span><span class="n">dq.qname</span><span class="p">)</span> <span class="kr">then</span>
        <span class="n">dq.appliedPolicy</span><span class="p">.</span><span class="n">policyKind</span> <span class="o">=</span> <span class="n">pdns.policykinds</span><span class="p">.</span><span class="n">Drop</span>  <span class="c1">-- 改写响应策略</span>
        <span class="kr">return</span> <span class="kc">false</span> <span class="c1">-- recursor still needs to handle the policy, 后续由定义策略处理</span>
    <span class="kr">end</span>

    <span class="kr">return</span> <span class="kc">false</span>
<span class="kr">end</span>

<span class="c1">-- 比较复杂的重写行为，可以在自建权威服务器的基础上，配合递归转发配置实现 dns 的内网劫持</span>
<span class="c1">-- 基本原理：查询请求由递归转发到自建域中，如果自建域不存在域名，再次转发到公网进行查询</span>
<span class="n">rewriteset</span> <span class="o">=</span> <span class="n">newDS</span><span class="p">()</span>
<span class="n">rewriteset</span><span class="p">:</span><span class="n">add</span><span class="p">(</span><span class="s2">&#34;powerdns.org&#34;</span><span class="p">)</span>
<span class="kr">function</span> <span class="nf">nxdomain</span><span class="p">(</span><span class="n">dq</span><span class="p">)</span>
    <span class="kr">if</span> <span class="n">rewriteset</span><span class="p">:</span><span class="n">check</span><span class="p">(</span><span class="n">dq.qname</span><span class="p">)</span> <span class="kr">then</span> 
        <span class="kd">local</span> <span class="n">dh</span> <span class="o">=</span> <span class="n">dq</span><span class="p">:</span><span class="n">getDH</span><span class="p">()</span>
        <span class="c1">-- 独立的处理函数 udpQueryResponse 允许发起新的 udp 查询，具体用法可以参考官方文档</span>
        <span class="n">dq.followupFunction</span> <span class="o">=</span> <span class="s2">&#34;udpQueryResponse&#34;</span>
        <span class="n">dq.udpCallback</span> <span class="o">=</span> <span class="s2">&#34;gotdomaindetails&#34;</span>  <span class="c1">-- 处理函数的回调函数</span>
        <span class="n">dq.udpQueryDest</span> <span class="o">=</span> <span class="n">newCA</span><span class="p">(</span><span class="s2">&#34;114.114.114.114:53&#34;</span><span class="p">)</span>
        <span class="c1">-- build_udp_package 需要自行实现，可以参考 lua-resty-dns ，工作内容为构建 dns 查询请求包</span>
        <span class="n">dq.udpQuery</span> <span class="o">=</span> <span class="n">build_udp_package</span><span class="p">(</span><span class="n">dq.qname</span><span class="p">:</span><span class="n">toString</span><span class="p">(),</span> <span class="n">dh</span><span class="p">:</span><span class="n">getID</span><span class="p">(),</span> <span class="n">dh</span><span class="p">:</span><span class="n">getRD</span><span class="p">())</span>
        <span class="kr">return</span> <span class="kc">true</span>
    <span class="kr">end</span>
    <span class="kr">return</span> <span class="kc">false</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">gotdomaindetails</span><span class="p">(</span><span class="n">dq</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">dh</span> <span class="o">=</span> <span class="n">dq</span><span class="p">:</span><span class="n">getDH</span><span class="p">()</span>
    <span class="c1">-- 回调函数需要清除上一步的 dq 对象的赋值</span>
    <span class="n">dq.followupFunction</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
    <span class="n">dq.udpCallback</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
    <span class="c1">-- parse_response 需要自行实现，可以参考 lua-resty-dns ，工作内容为解析 dns 响应包</span>
    <span class="kd">local</span> <span class="n">answers</span> <span class="o">=</span> <span class="n">parse_response</span><span class="p">(</span><span class="n">dq.udpAnswer</span><span class="p">,</span> <span class="n">dh</span><span class="p">:</span><span class="n">getID</span><span class="p">())</span>
    <span class="kr">if</span> <span class="ow">not</span> <span class="n">answers</span> <span class="kr">then</span>
        <span class="kr">return</span> <span class="kc">false</span>
    <span class="kr">end</span>
    <span class="kr">if</span> <span class="n">answers.errcode</span> <span class="kr">then</span>
        <span class="n">dq.rcode</span> <span class="o">=</span> <span class="n">answers.errcode</span>
        <span class="kr">return</span> <span class="kc">true</span>
    <span class="kr">end</span>
    <span class="kr">if</span> <span class="n">answers</span> <span class="kr">then</span>
        <span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">ans</span> <span class="kr">in</span> <span class="n">ipairs</span><span class="p">(</span><span class="n">answers</span><span class="p">)</span> <span class="kr">do</span>
            <span class="n">dq</span><span class="p">:</span><span class="n">addRecord</span><span class="p">(</span><span class="n">ans.type</span><span class="p">,</span> <span class="n">ans.address</span> <span class="ow">or</span> <span class="n">ans.cname</span><span class="p">,</span> <span class="n">ans.class</span><span class="p">,</span> <span class="n">ans.ttl</span><span class="p">,</span> <span class="n">ans.name</span><span class="p">)</span>
        <span class="kr">end</span>
        <span class="c1">-- 修改为正常应答</span>
        <span class="n">dq.rcode</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="kr">return</span> <span class="kc">true</span>
    <span class="kr">end</span>
<span class="kr">end</span>

<span class="c1">-- 自定义 metrics</span>
<span class="n">new_metrics</span> <span class="o">=</span> <span class="n">getMetric</span><span class="p">(</span><span class="s2">&#34;metrics&#34;</span><span class="p">)</span>  <span class="c1">-- 新增 metrics</span>
<span class="n">metrics</span><span class="p">:</span><span class="n">inc</span><span class="p">()</span>  <span class="c1">-- 增加 metrics 计数，更多 metrics 方法可以参考官方文档</span>
</code></pre></div><h2 id="参考文档">参考文档</h2>
<ul>
<li><a href="https://doc.powerdns.com/authoritative/performance.html">powerdns authoritative performance</a></li>
<li><a href="https://docs.powerdns.com/recursor/performance.html">powerdns recursor performance</a></li>
<li><a href="https://docs.powerdns.com/recursor/lua-scripting/index.html">powerdns recursor lua scripting</a></li>
</ul></article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
<script type="application/javascript" src='https://yuweizzz.github.io/js/toc.js'></script>
<link rel="stylesheet" href='https://yuweizzz.github.io/css/toc.css' />


  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://yuweizzz.github.io">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>
</body>

<script type="application/javascript" src="https://yuweizzz.github.io/js/github-style.js"></script>


<script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
<script type="text/javascript" src="https://yuweizzz.github.io/js/CustomLive2D.js"></script>


</html>
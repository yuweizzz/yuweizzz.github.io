<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://yuweizzz.github.io/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/github.min.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/github-style.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/light.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/dark.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/syntax.css' />
    <title>DNS 知识笔记 - Wei&#39;s blog</title>
    
    <link rel="icon" type="image/x-icon" href='/images/favicon.svg'>
    
    <meta name="theme-color" content="#1e2327">

    
    <meta name="description"
  content="这篇笔记用来记录 DNS 的相关知识。
" />
<meta name="keywords"
  content='blog, google analytics' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://yuweizzz.github.io/post/knowledge_about_dns/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="DNS 知识笔记 - Wei&#39;s blog" />
<meta name="twitter:description"
  content="这篇笔记用来记录 DNS 的相关知识。
" />
<meta name="twitter:site" content="https://yuweizzz.github.io/" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://yuweizzz.github.io/">


<meta property="og:type" content="article" />
<meta property="og:title" content="DNS 知识笔记 - Wei&#39;s blog">
<meta property="og:description"
  content="这篇笔记用来记录 DNS 的相关知识。
" />
<meta property="og:url" content="https://yuweizzz.github.io/post/knowledge_about_dns/" />
<meta property="og:site_name" content="DNS 知识笔记" />
<meta property="og:image"
  content="https://yuweizzz.github.io/">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2020-03-22 15:15:45 &#43;0000 UTC" />











  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-RFSQDKSFR1"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-RFSQDKSFR1');
        }
      </script>
    
  




</head>

<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://yuweizzz.github.io/">
        <img class="octicon" height="32" width="32" src="/images/github-mark-white.png">
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd" d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          
          <form target="_blank" id="search-form" action="" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
            </label>
          </form>
          
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://yuweizzz.github.io/">
        <img class="octicon octicon-mark-github v-align-middle" height="32" width="32" src="/images/github-mark-white.png">
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>

  <div id="search-result" class="container-lg px-3 new-discussion-timeline" style="display: none;">
</div>

  
<div class="application-main">
  <div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://yuweizzz.github.io/">
                  <img class=" avatar-user"
                    src="https://yuweizzz.github.io/images/avatar.png"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://yuweizzz.github.io/">Wei</a>
                  </span>
                  <span class="path-divider">/</span>
                  <strong class="css-truncate css-truncate-target mr-1" style="max-width: 410px">
                    <a href="https://yuweizzz.github.io/post/knowledge_about_dns/">DNS 知识笔记</a>
                  </strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Sun, 22 Mar 2020 15:15:45 &#43;0000"
                    class="no-wrap">
                    Sun, 22 Mar 2020 15:15:45 &#43;0000</relative-time>

                  
                  <span class="file-info-divider"></span>
                  Modified <relative-time datetime="Tue, 19 Nov 2024 09:35:43 &#43;0000"
                    class="no-wrap">
                    Tue, 19 Nov 2024 09:35:43 &#43;0000</relative-time>
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div id="post-header" class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style="z-index: 2">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    
                    <summary id="toc-toggle" onclick="clickToc()" class="btn btn-octicon m-0 mr-2 p-2">
                      <svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered">
                        <path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zM3 8a1 1 0 11-2 0 1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"></path>
                      </svg>
                    </summary>
                    <details-menu class="SelectMenu" id="toc-details" style="display: none;">
                      <div class="SelectMenu-modal rounded-3 mt-1" style="max-height: 340px;">
                        <div class="SelectMenu-list SelectMenu-list--borderless p-2" style="overscroll-behavior: contain;" id="toc-list">
                        </div>
                      </div>
                    </details-menu>
                      5436 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                    
                    <a class="muted-link mr-3" href="/tags/linux">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      Linux
                    </a>
                    
                    <a class="muted-link mr-3" href="/tags/dns">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      DNS
                    </a>
                    
                    <a class="muted-link mr-3" href="/tags/bind">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      BIND
                    </a>
                    
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5" style="z-index: 1">
                <article class="markdown-body entry-content container-lg"><p>这篇笔记用来记录 DNS 的相关知识。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                       <span class="o">(</span>@@<span class="o">)</span> <span class="o">(</span>  <span class="o">)</span> <span class="o">(</span>@<span class="o">)</span>  <span class="o">(</span> <span class="o">)</span>  @@    <span class="o">()</span>    @     O     @     O      @
</span></span><span class="line"><span class="cl">                                  <span class="o">(</span>   <span class="o">)</span>
</span></span><span class="line"><span class="cl">                              <span class="o">(</span>@@@@<span class="o">)</span>
</span></span><span class="line"><span class="cl">                           <span class="o">(</span>    <span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                         <span class="o">(</span>@@@<span class="o">)</span>
</span></span><span class="line"><span class="cl">                       <span class="o">====</span>        ________                ___________
</span></span><span class="line"><span class="cl">                   _D _<span class="p">|</span>  <span class="p">|</span>_______/        <span class="se">\_</span>_I_I_____<span class="o">===</span>__<span class="p">|</span>_________<span class="p">|</span>
</span></span><span class="line"><span class="cl">                    <span class="p">|</span><span class="o">(</span>_<span class="o">)</span>---  <span class="p">|</span>   H<span class="se">\_</span>_______/ <span class="p">|</span>   <span class="p">|</span>        <span class="o">=</span><span class="p">|</span>___ ___<span class="p">|</span>      _________________
</span></span><span class="line"><span class="cl">                    /     <span class="p">|</span>  <span class="p">|</span>   H  <span class="p">|</span>  <span class="p">|</span>     <span class="p">|</span>   <span class="p">|</span>         <span class="o">||</span>_<span class="p">|</span> <span class="p">|</span>_<span class="o">||</span>     _<span class="p">|</span>                <span class="se">\_</span>____A
</span></span><span class="line"><span class="cl">                   <span class="p">|</span>      <span class="p">|</span>  <span class="p">|</span>   H  <span class="p">|</span>__--------------------<span class="p">|</span> <span class="o">[</span>___<span class="o">]</span> <span class="p">|</span>   <span class="o">=</span><span class="p">|</span>                        <span class="p">|</span>
</span></span><span class="line"><span class="cl">                   <span class="p">|</span> ________<span class="p">|</span>___H__/__<span class="p">|</span>_____/<span class="o">[][]</span>~<span class="se">\_</span>______<span class="p">|</span>       <span class="p">|</span>   -<span class="p">|</span>                        <span class="p">|</span>
</span></span><span class="line"><span class="cl">                   <span class="p">|</span>/ <span class="p">|</span>   <span class="p">|</span>-----------I_____I <span class="o">[][]</span> <span class="o">[]</span>  D   <span class="p">|</span><span class="o">=======</span><span class="p">|</span>____<span class="p">|</span>________________________<span class="p">|</span>_
</span></span><span class="line"><span class="cl">                 __/ <span class="o">=</span><span class="p">|</span> o <span class="p">|</span><span class="o">=</span>-~O<span class="o">=====</span><span class="nv">O</span><span class="o">=====</span><span class="nv">O</span><span class="o">=====</span>O<span class="se">\ </span>____Y___________<span class="p">|</span>__<span class="p">|</span>__________________________<span class="p">|</span>_
</span></span><span class="line"><span class="cl">                  <span class="p">|</span>/-<span class="o">=</span><span class="p">|</span>___<span class="p">|</span><span class="o">=</span>    <span class="o">||</span>    <span class="o">||</span>    <span class="o">||</span>    <span class="p">|</span>_____/~<span class="se">\_</span>__/          <span class="p">|</span>_D__D__D_<span class="p">|</span>  <span class="p">|</span>_D__D__D_<span class="p">|</span>
</span></span><span class="line"><span class="cl">                   <span class="se">\_</span>/      <span class="se">\_</span>_/  <span class="se">\_</span>_/  <span class="se">\_</span>_/  <span class="se">\_</span>_/      <span class="se">\_</span>/               <span class="se">\_</span>/   <span class="se">\_</span>/    <span class="se">\_</span>/   <span class="se">\_</span>/
</span></span></code></pre></div><h2 id="前言">前言</h2>
<p>网络服务是一般是基于 IP 地址提供的，但是 IP 地址比较难记，所以现实中使用了人类便于记忆的域名来访问网络服务。</p>
<p>而 DNS 服务器负责提供域名和 IP 地址映射关系查询的服务，一般叫做域名解析。</p>
<h2 id="dns-配置文件">DNS 配置文件</h2>
<p>在使用网络服务时，域名解析的工作由操作系统的全局配置的 DNS 服务器负责。</p>
<p>DNS 带有缓存机制，短时间的相同请求并不会多次请求 DNS 服务器，而会直接使用缓存，直到缓存过期后发起新的查询请求。</p>
<p>除了自身的 DNS 缓存和发起新的查询请求，本地 hosts 也可以提供类似于 DNS 的服务，它是可以自行定义的域名和 IP 地址的映射表，能够一定程度上优化 DNS 解析的进行，但现实中它多用于开发过程中的调试。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 全局配置的 DNS 服务器</span>
</span></span><span class="line"><span class="cl">$ cat /etc/resolv.conf
</span></span><span class="line"><span class="cl"><span class="p">;</span> generated by /sbin/dhclient-script
</span></span><span class="line"><span class="cl">nameserver 192.168.0.1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 本地 hosts 定义的映射关系</span>
</span></span><span class="line"><span class="cl">$ cat /etc/hosts
</span></span><span class="line"><span class="cl">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
</span></span><span class="line"><span class="cl">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
</span></span><span class="line"><span class="cl"><span class="c1"># 在这个文件中写入 IP 地址和对应域名，在访问对应域名时会直接使用文件中给定的 IP 地址</span>
</span></span></code></pre></div><h2 id="dns-查询规则">DNS 查询规则</h2>
<h3 id="域名解析记录类型">域名解析记录类型</h3>
<p>发起域名查询的工具有 <code>nslookup</code> 和 <code>dig</code> ，使用 <code>dig</code> 可以输出详细的域名解析记录。</p>
<p><code>dig</code> 查询返回的域名解析记录的类型比较多，下面列出常见的域名解析记录类型：</p>
<ul>
<li>A ：解析对应域名的 IPv4 地址。</li>
<li>AAAA ：解析对应域名的 IPv6 地址。</li>
<li>CNAME ：全称为 Canonical Name ，用它来将为一个域名设置多个别名，使得不同域名最终解析到相同的 IP 地址。</li>
<li>SOA ：用来表示此指明域名的主要 DNS 服务器，并设置记录的过期时间和版本信息。</li>
<li>NS ：用来指明 DNS 服务器的 IP 地址， NS 记录可以有多个。</li>
<li>MX ：全称为 Mail Exchange ，用来指定邮件服务器的 IP 地址。</li>
<li>PTR ：反向解析记录，用来记录 IP 地址对应的域名信息。</li>
<li>SRV ：用来记录提供特定服务的域名。</li>
<li>TXT ：用来设置域名的说明信息。</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 使用 dig 对域名发起解析请求</span>
</span></span><span class="line"><span class="cl">$ dig github.com +noauthority +noadditional
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span> &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7_9.4 &lt;&lt;&gt;&gt; github.com +noauthority +noadditional
</span></span><span class="line"><span class="cl"><span class="p">;;</span> global options: +cmd
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Got answer:
</span></span><span class="line"><span class="cl"><span class="p">;;</span> -&gt;&gt;HEADER<span class="s">&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span class="m">8528</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> flags: qr rd ra ad<span class="p">;</span> QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: <span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> QUESTION SECTION:
</span></span><span class="line"><span class="cl"><span class="p">;</span>github.com.   IN A
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> ANSWER SECTION:
</span></span><span class="line"><span class="cl">github.com.  <span class="m">572</span> IN A 20.205.243.166
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Query time: <span class="m">41</span> msec
</span></span><span class="line"><span class="cl"><span class="p">;;</span> SERVER: 192.168.0.1#53<span class="o">(</span>192.168.0.1<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> WHEN: Sat Jan <span class="m">08</span> 16:24:44 CST <span class="m">2022</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> MSG SIZE  rcvd: <span class="m">44</span>
</span></span></code></pre></div><p>访问站点需要的是 A 记录，这里省去了 dig 输出的 authority 和 additional 部分， authority 包含了所有的权威 DNS 服务器， additional 包含了 authority 中服务器的 A 记录。</p>
<h3 id="根服务器和权威服务器">根服务器和权威服务器</h3>
<p>实际中使用的域名通过 <code>.</code> 来划分不同的域，例如 <code>github.com</code> 这个域名就可以划分为二级域 <code>github</code> 和一级域 <code>com</code> 。</p>
<p>在前面使用 <code>dig</code> 进行域名查询时，可以看到在 A 记录中，它的域名显示为 <code>github.com.</code> ，这个 <code>.</code> 代表根域，它是所有域名的起源。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ dig . -t soa +noadditional
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Warning: Message parser reports malformed message packet.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span> &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7_9.4 &lt;&lt;&gt;&gt; . -t soa +noadditional
</span></span><span class="line"><span class="cl"><span class="p">;;</span> global options: +cmd
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Got answer:
</span></span><span class="line"><span class="cl"><span class="p">;;</span> -&gt;&gt;HEADER<span class="s">&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span class="m">32440</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> flags: qr rd ra<span class="p">;</span> QUERY: 1, ANSWER: 1, AUTHORITY: 13, ADDITIONAL: <span class="m">26</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> WARNING: Message has <span class="m">7</span> extra bytes at end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> QUESTION SECTION:
</span></span><span class="line"><span class="cl"><span class="p">;</span>.    IN SOA
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> ANSWER SECTION:
</span></span><span class="line"><span class="cl">.   <span class="m">3595</span> IN SOA a.root-servers.net. nstld.verisign-grs.com. <span class="m">2022010700</span> <span class="m">1800</span> <span class="m">900</span> <span class="m">604800</span> <span class="m">86400</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> AUTHORITY SECTION:
</span></span><span class="line"><span class="cl">.   <span class="m">260739</span> IN NS j.root-servers.net.
</span></span><span class="line"><span class="cl">.   <span class="m">260739</span> IN NS f.root-servers.net.
</span></span><span class="line"><span class="cl">.   <span class="m">260739</span> IN NS c.root-servers.net.
</span></span><span class="line"><span class="cl">.   <span class="m">260739</span> IN NS i.root-servers.net.
</span></span><span class="line"><span class="cl">.   <span class="m">260739</span> IN NS h.root-servers.net.
</span></span><span class="line"><span class="cl">.   <span class="m">260739</span> IN NS d.root-servers.net.
</span></span><span class="line"><span class="cl">.   <span class="m">260739</span> IN NS k.root-servers.net.
</span></span><span class="line"><span class="cl">.   <span class="m">260739</span> IN NS l.root-servers.net.
</span></span><span class="line"><span class="cl">.   <span class="m">260739</span> IN NS a.root-servers.net.
</span></span><span class="line"><span class="cl">.   <span class="m">260739</span> IN NS b.root-servers.net.
</span></span><span class="line"><span class="cl">.   <span class="m">260739</span> IN NS g.root-servers.net.
</span></span><span class="line"><span class="cl">.   <span class="m">260739</span> IN NS e.root-servers.net.
</span></span><span class="line"><span class="cl">.   <span class="m">260739</span> IN NS m.root-servers.net.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Query time: <span class="m">11</span> msec
</span></span><span class="line"><span class="cl"><span class="p">;;</span> SERVER: 192.168.0.1#53<span class="o">(</span>192.168.0.1<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> WHEN: Sat Jan <span class="m">08</span> 16:50:46 CST <span class="m">2022</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> MSG SIZE  rcvd: <span class="m">512</span>
</span></span></code></pre></div><p>根域一共有 13 台 DNS 服务器，由于根域的需要处理的请求数量比较大，所以根域 DNS 服务器中只保存解析一级域的相关记录。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 使用 dig 获取域名的权威 DNS</span>
</span></span><span class="line"><span class="cl"> dig github.com +noadditional -t soa
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Warning: Message parser reports malformed message packet.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span> &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7_9.4 &lt;&lt;&gt;&gt; github.com +noadditional -t soa
</span></span><span class="line"><span class="cl"><span class="p">;;</span> global options: +cmd
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Got answer:
</span></span><span class="line"><span class="cl"><span class="p">;;</span> -&gt;&gt;HEADER<span class="s">&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span class="m">61395</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> flags: qr rd ra<span class="p">;</span> QUERY: 1, ANSWER: 1, AUTHORITY: 8, ADDITIONAL: <span class="m">17</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> QUESTION SECTION:
</span></span><span class="line"><span class="cl"><span class="p">;</span>github.com.   IN SOA
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> ANSWER SECTION:
</span></span><span class="line"><span class="cl">github.com.  <span class="m">3478</span> IN SOA dns1.p08.nsone.net. hostmaster.nsone.net. <span class="m">1641583307</span> <span class="m">43200</span> <span class="m">7200</span> <span class="m">1209600</span> <span class="m">3600</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> AUTHORITY SECTION:
</span></span><span class="line"><span class="cl">github.com.  <span class="m">520</span> IN NS dns2.p08.nsone.net.
</span></span><span class="line"><span class="cl">github.com.  <span class="m">520</span> IN NS ns-421.awsdns-52.com.
</span></span><span class="line"><span class="cl">github.com.  <span class="m">520</span> IN NS dns4.p08.nsone.net.
</span></span><span class="line"><span class="cl">github.com.  <span class="m">520</span> IN NS ns-1283.awsdns-32.org.
</span></span><span class="line"><span class="cl">github.com.  <span class="m">520</span> IN NS ns-520.awsdns-01.net.
</span></span><span class="line"><span class="cl">github.com.  <span class="m">520</span> IN NS dns1.p08.nsone.net.
</span></span><span class="line"><span class="cl">github.com.  <span class="m">520</span> IN NS ns-1707.awsdns-21.co.uk.
</span></span><span class="line"><span class="cl">github.com.  <span class="m">520</span> IN NS dns3.p08.nsone.net.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Query time: <span class="m">16</span> msec
</span></span><span class="line"><span class="cl"><span class="p">;;</span> SERVER: 192.168.0.1#53<span class="o">(</span>192.168.0.1<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> WHEN: Sat Jan <span class="m">08</span> 22:08:46 CST <span class="m">2022</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> MSG SIZE  rcvd: <span class="m">512</span>
</span></span></code></pre></div><p>权威 DNS 服务器是域名的可信解析来源，一般来说 SOA 记录指定的 DNS 服务器就是权威 DNS ，但是为了保证域名查询的可用性，一般会设置多个 NS 记录，它们会在 <code>dig</code> 输出的 authority 部分，它们也属于权威 DNS 服务器。</p>
<h3 id="递归查询和迭代查询">递归查询和迭代查询</h3>
<p>一次 DNS 查询行为一般由递归查询和迭代查询协作完成。</p>
<p>我们在浏览器上访问一个新的网站，这个时候一般需要向全局设置的 DNS 发起一个新的 DNS 递归查询。</p>
<p>假设全局设置的 DNS 服务器没有所请求域名的缓存，并且不是所请求域名的权威 DNS ，那么在它允许接受递归查询的前提下，会进行如下工作：</p>
<ul>
<li>本地全局 DNS 服务器向根服务器发起目标一级域的查询请求。</li>
<li>本地全局 DNS 服务器接收到目标一级域权威 DNS 的记录信息应答，向这个权威 DNS 发起目标二级域的查询请求。</li>
<li>本地全局 DNS 服务器接收到目标二级域权威 DNS 的记录信息应答，向这个权威 DNS 发起目标域名的查询请求。</li>
<li>本地全局 DNS 服务器接收到目标域名的 A 记录信息应答，将结果返回给我们。</li>
</ul>
<p>以上是一个理想化的工作链，实际中这个过程会因为缓存而加快。</p>
<p>在这个过程，用户向本地 DNS 发起的是递归请求，它的特点是发起一次请求，要求返回所请求域名的最终结果。本地 DNS 服务器接收了递归请求，会发起多个请求按层次解析域名，这些请求就是迭代请求。为了提高性能，一些 DNS 服务器不应该接受递归请求，比如根服务器和一级域权威 DNS 服务器。</p>
<p>允许接受递归请求的 DNS 服务器一般都开启了缓存功能，而且它们都保存了根服务器的地址，以保证前面所述的工作链能正常执行。</p>
<h2 id="dns-服务软件-bind">DNS 服务软件 BIND</h2>
<p>BIND (Berkeley internet Name Domain) 是最常用的 DNS 服务软件，我们通过它的服务配置可以更好理解 DNS 解析的运行。</p>
<h3 id="bind-基本配置">BIND 基本配置</h3>
<p>BIND 的配置文件 <code>named.conf</code> 语法和一些常规软件相似，在 <code>/usr/share/doc/bind-&lt;version&gt;/sample/etc/</code> 中找到配置文件的参考模板。</p>
<p>BIND 还提供了管理工具 rndc ，这个管理工具的配置文件为 <code>/etc/rndc.conf</code> 。</p>
<p>在 <code>named.conf</code> 中，比较重要的配置项如下：</p>
<ul>
<li>listen-on 和 listen-on-v6 定义了服务的 IP 地址和端口， DNS 服务的默认端口为 53 。</li>
<li>directory 定义了工作目录，默认为 <code>/var/named</code> 。</li>
<li>recursion 定义是否允许接受递归查询请求。</li>
<li>allow-query 定义了允许访问本机 DNS 服务的主机。</li>
<li>allow-query-cache 定义了规定允许访问本机 DNS 服务的缓存的主机。</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 查看 named.conf</span>
</span></span><span class="line"><span class="cl">$ cat /etc/named.conf
</span></span><span class="line"><span class="cl">options <span class="o">{</span>
</span></span><span class="line"><span class="cl"> listen-on port <span class="m">53</span> <span class="o">{</span> 127.0.0.1<span class="p">;</span> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> listen-on-v6 port <span class="m">53</span> <span class="o">{</span> ::1<span class="p">;</span> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="c1"># 默认工作目录</span>
</span></span><span class="line"><span class="cl"> directory  <span class="s2">&#34;/var/named&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="c1"># 运行 rndc dumpdb 后，named 服务缓存信息的保存路径</span>
</span></span><span class="line"><span class="cl"> dump-file  <span class="s2">&#34;/var/named/data/cache_dump.db&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="c1"># 运行 rndc stats 后，named 服务的统计信息的保存路径</span>
</span></span><span class="line"><span class="cl"> statistics-file <span class="s2">&#34;/var/named/data/named_stats.txt&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> memstatistics-file <span class="s2">&#34;/var/named/data/named_mem_stats.txt&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="c1"># 运行接入的主机名单</span>
</span></span><span class="line"><span class="cl"> allow-query     <span class="o">{</span> localhost<span class="p">;</span> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> allow-query-cache     <span class="o">{</span> localhost<span class="p">;</span> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="c1"># 递归查询</span>
</span></span><span class="line"><span class="cl"> recursion no<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="c1"># dns 安全扩展</span>
</span></span><span class="line"><span class="cl"> dnssec-enable no<span class="p">;</span>
</span></span><span class="line"><span class="cl"> dnssec-validation no<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> bindkeys-file <span class="s2">&#34;/etc/named.root.key&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> managed-keys-directory <span class="s2">&#34;/var/named/dynamic&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">logging <span class="o">{</span>
</span></span><span class="line"><span class="cl"> channel default_debug <span class="o">{</span>
</span></span><span class="line"><span class="cl">  file <span class="s2">&#34;data/named.run&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  severity dynamic<span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">zone <span class="s2">&#34;.&#34;</span> IN <span class="o">{</span>
</span></span><span class="line"><span class="cl"> <span class="nb">type</span> hint<span class="p">;</span>
</span></span><span class="line"><span class="cl"> file <span class="s2">&#34;named.ca&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">include <span class="s2">&#34;/etc/named.rfc1912.zones&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">include <span class="s2">&#34;/etc/named.root.key&#34;</span><span class="p">;</span>
</span></span></code></pre></div><h3 id="配置-zone">配置 zone</h3>
<p>除了基本的服务信息的配置，每个 zone 的配置是实际域名记录的来源。</p>
<p>在前面的 <code>named.conf</code> 已经有了关于根域的配置，可以看到域的配置比较简单。</p>
<p>域使用 file 来指向位于工作目录中，包含域解析信息的文件。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># named.conf 中包含的 named.rfc1912.zones 定义了标准的本地域名</span>
</span></span><span class="line"><span class="cl">$ cat /etc/named.rfc1912.zones
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">zone <span class="s2">&#34;.&#34;</span> IN <span class="o">{</span>
</span></span><span class="line"><span class="cl"> <span class="nb">type</span> hint<span class="p">;</span>
</span></span><span class="line"><span class="cl"> file <span class="s2">&#34;named.ca&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">zone <span class="s2">&#34;localhost&#34;</span> IN <span class="o">{</span>
</span></span><span class="line"><span class="cl"> <span class="nb">type</span> master<span class="p">;</span>
</span></span><span class="line"><span class="cl"> file <span class="s2">&#34;named.localhost&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> allow-update <span class="o">{</span> none<span class="p">;</span> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">zone <span class="s2">&#34;1.0.0.127.in-addr.arpa&#34;</span> IN <span class="o">{</span>
</span></span><span class="line"><span class="cl"> <span class="nb">type</span> master<span class="p">;</span>
</span></span><span class="line"><span class="cl"> file <span class="s2">&#34;named.loopback&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> allow-update <span class="o">{</span> none<span class="p">;</span> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="c1"># 查看 zone file 的具体内容：</span>
</span></span><span class="line"><span class="cl">$ cat /var/named/named.loopback
</span></span><span class="line"><span class="cl"><span class="nv">$TTL</span> 1D
</span></span><span class="line"><span class="cl">@ IN SOA @ rname.invalid. <span class="o">(</span>
</span></span><span class="line"><span class="cl">     <span class="m">0</span> <span class="p">;</span> serial
</span></span><span class="line"><span class="cl">     1D <span class="p">;</span> refresh
</span></span><span class="line"><span class="cl">     1H <span class="p">;</span> retry
</span></span><span class="line"><span class="cl">     1W <span class="p">;</span> expire
</span></span><span class="line"><span class="cl">     3H <span class="o">)</span> <span class="p">;</span> minimum
</span></span><span class="line"><span class="cl"> NS @
</span></span><span class="line"><span class="cl"> A 127.0.0.1
</span></span><span class="line"><span class="cl"> AAAA ::1
</span></span><span class="line"><span class="cl"> PTR localhost.
</span></span></code></pre></div><p>在上述 zone file 中，你可以发现 PTR 记录为 <code>localhost.</code> ，它以 <code>.</code> 作为结尾，说明它是完全限定域名 FQDN 。如果在 zone file 中的域名记录不是 FQDN ，会被执行额外的替换工作，这将会由 <code>$ORIGIN</code> 决定。</p>
<p>替换的规则大概如下：</p>
<ul>
<li>@ 用来代表 <code>$ORIGIN</code> 。</li>
<li>如果 zone file 中没有定义过 <code>$ORIGIN</code> ，那么 <code>$ORIGIN</code> 默认是 zone name 加上 <code>.</code> 。</li>
<li>zone file 在加载时会检查非 FQDN ，并使用 <code>$ORIGIN</code> 修改它，即当 <code>$ORIGIN localhost.</code> 和 <code>hostname A 127.0.0.2</code> 时，这条记录实际为 <code>hostname.localhost. A 127.0.0.2</code> 。</li>
<li><code>$ORIGIN</code> 可以在 zone file 中任意位置重新定义，后续的记录会按照新定义的 <code>$ORIGIN</code> 进行对应的 FQDN 修改，定义 <code>$ORIGIN</code> 前的记录会使用默认的 <code>$ORIGIN</code> ，也就是 zone name 加上 <code>.</code> 。</li>
<li>如果自定义 <code>$ORIGIN</code> 不以 <code>.</code> 结尾，那么这个 <code>$ORIGIN</code> 也会自动补上 zone name 作为新的 <code>$ORIGIN</code> ，然后再替换后续的非 FQDN 。</li>
<li>自定义的 <code>$ORIGIN</code> 不应该脱离原有的 zone name ，否则记录无法找到对应的 zone ，将无法正确解析。</li>
</ul>
<p>除了特殊变量，其他的域名记录一般以 <code>hostname A 127.0.0.1</code> 这样的格式定义，前面的域名解析记录类型都可以在 zone file 中定义。</p>
<p>写入了 zone file 后，还需要在 name.conf 中定义 zone 和它的对应名称，并且有相应的关键字去实现细节定义。</p>
<p>在 named.conf 中，使用 allow-update 关键字用来声明允许动态更新该域的主机，并且有四种 zone type ：</p>
<ul>
<li>hint 表示该域是根域， <code>/etc/named.ca</code> 中保存了根服务器的地址。</li>
<li>master 表示该域为权威域。</li>
<li>slave 表示该域为辅助域。</li>
<li>forward 表示该域为转发域。</li>
</ul>
<p>使用不同的 zone type 共同协作才能支持 DNS 服务。</p>
<h4 id="使用-master-和-slave-设置主从域">使用 master 和 slave 设置主从域</h4>
<p>一般来说，合理的 DNS 服务需要两台 DNS 服务器，分别用来设置主 DNS 服务器和从 DNS 服务器，提高整体服务的可靠性。</p>
<p>我们将 type 为 master 的 zone 放在主 DNS 服务器中，并将相同 zone name 的 salve 域放在从 DNS 服务器，做好同步设置，它们之间就可以同步域名记录。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 假设主 DNS 的 IP 地址为 192.168.0.1 ，从 DNS 的 IP 地址为 192.168.0.2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 写入到主 DNS 的 named.conf 中</span>
</span></span><span class="line"><span class="cl">zone <span class="s2">&#34;example.com&#34;</span> IN <span class="o">{</span>
</span></span><span class="line"><span class="cl"> <span class="nb">type</span> master<span class="p">;</span>
</span></span><span class="line"><span class="cl"> file <span class="s2">&#34;zone.file&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> allow-transfer<span class="o">{</span>
</span></span><span class="line"><span class="cl">  192.168.0.2<span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> notify yes<span class="p">;</span>
</span></span><span class="line"><span class="cl"> also-notify<span class="o">{</span>
</span></span><span class="line"><span class="cl">  192.168.0.2<span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 写入到从 DNS 的 named.conf 中</span>
</span></span><span class="line"><span class="cl">zone <span class="s2">&#34;example.com&#34;</span> IN <span class="o">{</span>
</span></span><span class="line"><span class="cl"> <span class="nb">type</span> slave<span class="p">;</span>
</span></span><span class="line"><span class="cl"> file <span class="s2">&#34;salve/zone.file&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> masters<span class="o">{</span>
</span></span><span class="line"><span class="cl">  192.168.0.1<span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span></code></pre></div><p>配置的主要关键字有以下几个：</p>
<ul>
<li>allow-transfer 用于声明允许同步的从 DNS 服务器。</li>
<li>notify 用于开启域名记录更新通知。</li>
<li>also-notify 用于声明在域名记录更新后，需要主动通知的从 DNS 服务器。</li>
<li>masters 用于声明该域的主 DNS 服务器，会使用在从 DNS 服务器中。</li>
</ul>
<p>这几个关键字可以在 named.conf 的 options 中使用，这样全局的域都会遵从关键字定义的主从配置。</p>
<p>主从同步的步骤大概如下：</p>
<ol>
<li>当主 DNS 服务器的域名记录更新后，启用了 notify 的域会向 also-notify 的从 DNS 服务器列表发送 notify 消息。</li>
<li>接收 notify 后，从 DNS 服务器发起 SOA 请求，将结果和该域在本机中 SOA 记录中的 serial 进行对比，如果小于本机的 serial 就结束同步过程。</li>
<li>如果大于本机的 serial ，则从 DNS 服务器会向主 DNS 服务器发起 transfer 请求，一般是 IXFR 增量同步请求。</li>
<li>主 DNS 服务器检查 transfer 请求是否来自 allow-transfer 的从 DNS 服务器。</li>
<li>检查通过则传输数据，完成同步。</li>
</ol>
<h4 id="使用-forward-设置转发域">使用 forward 设置转发域</h4>
<p>如果 DNS 服务器不是某个 zone 的权威 DNS ，那么可以将这个域设置为转发域，将对该域的请求转发到指定的 DNS 服务器中。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 转发域的设置用法</span>
</span></span><span class="line"><span class="cl">$ cat /etc/named.conf
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">options <span class="o">{</span>
</span></span><span class="line"><span class="cl"> forward <span class="o">[</span> first <span class="p">|</span> only <span class="o">]</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> forwarders <span class="o">{</span> ... <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">zone <span class="s2">&#34;example.com&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"> <span class="nb">type</span> forward<span class="p">;</span>
</span></span><span class="line"><span class="cl"> forwarders <span class="o">{</span> ... <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>forward 提供 first 和 only 两个定义项：</p>
<ul>
<li>first 会优先将请求转发到 forwarders 中，如果 forwarders 查询不到记录，则使用本机来进行查询。</li>
<li>only 会将所有请求转发到 forwarders 中，如果 forwarders 查询不到记录，则直接返回查询失败。</li>
</ul>
<p>也可以在单一域中设置转发，并且在单一域中设置的 forwarders 可以覆盖掉全局的 forwarders 。</p>
<p>在上述的前提下，我们可以特殊置空某些域的 forwarders 。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 置空某些域的转发，使其作为权威域</span>
</span></span><span class="line"><span class="cl">$ cat /etc/named.conf
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">options <span class="o">{</span>
</span></span><span class="line"><span class="cl"> forward <span class="o">[</span> first <span class="p">|</span> only <span class="o">]</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> forwarders <span class="o">{</span> ... <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">zone <span class="s2">&#34;example.com&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"> <span class="nb">type</span> master<span class="p">;</span>
</span></span><span class="line"><span class="cl"> file <span class="s2">&#34;zone.file&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> forwarders <span class="o">{}</span><span class="p">;</span>  <span class="c1"># 置空 forwarders</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>这样设置可以起到在全局转发的情况下，某些域可以直接在本地进行权威查询的效果。</p>
<h3 id="使用-view-配置智能-dns">使用 view 配置智能 DNS</h3>
<p>在 named.conf 中使用 view 关键字可以实现简单的智能 DNS 。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ cat /etc/named.conf
</span></span><span class="line"><span class="cl">options <span class="o">{</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"> view <span class="s1">&#39;viewA&#39;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  match-client <span class="o">{</span>...<span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  zone <span class="s2">&#34;A.com&#34;</span> IN <span class="o">{</span>...<span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  zone <span class="s2">&#34;B.com&#34;</span> IN <span class="o">{</span>...<span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> view <span class="s1">&#39;viewB&#39;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  match-client <span class="o">{</span>...<span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  zone <span class="s2">&#34;A.com&#34;</span> IN <span class="o">{</span>...<span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  zone <span class="s2">&#34;B.com&#34;</span> IN <span class="o">{</span>...<span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span></code></pre></div><p>这样设置可以实现用户分离，只要查询请求的来源符合对应的 match-client ，就使用对应的 view 去响应请求，达到智能化响应请求的效果。</p>
<h3 id="使用-dnssec-应对域名欺骗">使用 dnssec 应对域名欺骗</h3>
<p>dnssec 是一种应对域名欺骗的 DNS 安全技术，在递归服务器向根服务器发起查询的过程中，迭代查询时返回的记录可能是一个伪造的响应，导致最终域名解析到了错误的地址，如果使用 dnssec ，就可以验证返回记录的完整性和真实性。</p>
<p>dnssec 引入了一些新的记录类型，比较重要的有以下几种：</p>
<ul>
<li>RRSIG ：域记录的数字签名，由服务端使用私钥生成。</li>
<li>DNSKEY ：该域进行数字签名的公钥。</li>
<li>DS ：用于记录下级域的公钥验证信息，是形成整条信任链的关键记录。</li>
</ul>
<p>开启 dnssec 支持的查询过程大概如下：</p>
<ol>
<li>在向权威 DNS 服务器发起正常 A 记录请求的同时，发起本次请求同时启用 dnssec 的信息。</li>
<li>如果目标 DNS 服务器不支持 dnssec ，则它只处理 A 记录请求。</li>
<li>如果目标 DNS 服务器支持 dnssec ，那么目标 DNS 服务器还会一并返回该 A 记录的 RRSIG 。</li>
<li>向目标 DNS 服务器请求 DNSKEY 和 DNSKEY 记录的 RRSIG ，使用 DNSKEY 验证上一步 A 记录的 RRSIG 。</li>
<li>向上级域请求 DS 记录和 DS 记录的 RRSIG ，然后使用 DS 记录验证上一步 DNSKEY 记录的 RRSIG 。</li>
<li>向更上一级域请求 DNSKEY 和对应的 RRSIG ，然后使用 DNSKEY 验证上一步 DS 记录的 RRSIG 。</li>
<li>重复步骤 5 和 步骤 6 ，验证一系列域的 DNSKEY 和 DS 记录的 RRSIG 。</li>
<li>到达根域后，由于根域的 DNSKEY 已经配置在服务中，所以整个查询链都是生效的。</li>
</ol>
<p>可以看到，在这个过程中， DS 用于对 DNSKEY 的认证， RRSIG 用于对查询记录的认证， DNSKEY 是用于解密 RRSIG 的公钥， dnssec 的信任链机制类似于 SSL 的 CA ，因为根域的密钥已经默认配置，所以需要通过逐级信任 DS 记录来构建整条信任链，三种记录协作完成 dnssec 的验证。</p>
<p>在 named.conf 中，使用以下关键字配置 dnssec ：</p>
<ul>
<li>dnssec-enable 定义了是否对本地权威域启用 dnssec 。</li>
<li>dnssec-validation 定义了是否对返回的 RRSIG 进行验证，如果开启这个选项，使用 dig 工具测试签名验证成功会带有 ad 标志。</li>
<li>bindkeys-file 用于内置信任的密钥文件，一般是根域的密钥信息。</li>
<li>managed-keys-directory 用于指定迭代过程中，可信任 dnssec 密钥存储目录。</li>
</ul>
<p>如果要对本地的权威域需要开启 dnssec ，则需要使用配套工具生成密钥对，然后对 zone file 进行数字签名，并修改对应的配置文件。</p>
<p>在面向公众的 DNS 服务，可以选择开启 dnssec ，而作为内网 DNS 服务时则没有必要开启 dnssec 。</p>
<h3 id="使用-rndc-管理-bind">使用 rndc 管理 BIND</h3>
<p>rndc 是 BIND 内置的管理工具，可以在本地和远端对运行中的 BIND 进行操作和管理。</p>
<p>bind 还提供了一个管理工具 rndc ，来对 named 进行操作和管理，这个工具的特点是可以在 named 运行过程中动态修改部分配置。它通过 TCP 连接和 named 进行交互，这个工具可以在本地和远端使用，通过 TCP 连接到 953 端口和 BIND 服务进行通信。</p>
<p>BIND 提供了 <code>rndc-confgen</code> 来帮助配置 rndc 。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 生成 rndc.conf 文件：</span>
</span></span><span class="line"><span class="cl">$ rndc-confgen
</span></span><span class="line"><span class="cl"><span class="c1"># Start of rndc.conf</span>
</span></span><span class="line"><span class="cl">key <span class="s2">&#34;rndc-key&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"> algorithm hmac-md5<span class="p">;</span>
</span></span><span class="line"><span class="cl"> secret <span class="s2">&#34;iY/Zua49dUCZroBHAysTqA==&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">options <span class="o">{</span>
</span></span><span class="line"><span class="cl"> default-key <span class="s2">&#34;rndc-key&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> default-server 127.0.0.1<span class="p">;</span>
</span></span><span class="line"><span class="cl"> default-port 953<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># End of rndc.conf</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 以下需要去掉注释后写入到 /etc/named.conf</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Use with the following in named.conf, adjusting the allow list as needed:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># key &#34;rndc-key&#34; {</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  algorithm hmac-md5;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  secret &#34;iY/Zua49dUCZroBHAysTqA==&#34;;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># };</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># controls {</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  inet 127.0.0.1 port 953</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   allow { 127.0.0.1; } keys { &#34;rndc-key&#34;; };</span>
</span></span><span class="line"><span class="cl"><span class="c1"># };</span>
</span></span><span class="line"><span class="cl"><span class="c1"># End of named.conf</span>
</span></span></code></pre></div><p>它也提供了使用说明，只需要将 <code>rndc-confgen</code> 的输出写入到 <code>/etc/rndc.conf</code> 中，并将输出中注释的 <code>key</code> 和 <code>controls</code> 写入到 <code>/etc/named.conf</code> 中，就可以正常使用 rndc 了。</p>
<p>如果把 <code>controls</code> 部分的本地回环 IP 地址修改为对外的 IP 地址，则 rndc 可以从远端通过网络进行控制。</p>
<p>rndc 提供了很多功能，以下列出几个常用的命令：</p>
<ul>
<li><code>rndc status</code> ：用于查看服务端的运行信息。</li>
<li><code>rndc stats</code> ：用于保存 named 服务的运行的统计信息，<code>named.conf</code> 中的 statistics-file 将会是统计的保存路径，这些数据可以用作监控。</li>
<li><code>rndc dumpdb</code> ：用于保存 named 服务所缓存的记录，<code>named.conf</code> 中的 dump-file 将会是缓存的保存路径。</li>
<li><code>rndc flush</code> ：用于清除已缓存的查询记录。</li>
<li><code>rndc reload</code> ：用来重新载入 named 服务的配置文件，也可以用于刷新某个域信息。</li>
<li><code>rndc addzone</code> ：用来动态添加域，使用的方法通常会是 <code>rndc addzone example.com '{type master; file &quot;example.com.zone&quot;;};'</code> 。</li>
<li><code>rndc delzone</code> ：用来动态删除域，使用的方法通常会是 <code>rndc delzone example.com</code> 。</li>
</ul>
<p>如果使用 addzone 和 delzone 来动态更新域，需要注意以下几个点：</p>
<ul>
<li>使用动态域更新需要在 <code>/etc/named.conf</code> 的 <code>options</code> 下添加 <code>allow-new-zones yes</code> 。</li>
<li>新增域的文件需要放在 named 服务定义的工作目录中，并符合 named 服务应有的读写权限。</li>
<li>动态域更新会在工作目录下使用 nzf 为结尾的文件来保存动态域的信息，所以这个文件不应该被手动修改。</li>
<li>如果动态域更新失败，有可能是 selinux 安全策略导致的，请检查整体配置或者 named_write_master_zones 并使用 setsebool 修改后再尝试。</li>
</ul></article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
<script type="application/javascript" src='https://yuweizzz.github.io/js/toc.js'></script>
<link rel="stylesheet" href='https://yuweizzz.github.io/css/toc.css' />

  
</div>

  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://yuweizzz.github.io/">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>
</body>

<script type="application/javascript" src="https://yuweizzz.github.io/js/github-style.js"></script>





<script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
<script type="application/javascript" src='https://yuweizzz.github.io/js/search.js'></script>


<script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
<script type="text/javascript" src="https://yuweizzz.github.io/js/CustomLive2D.js"></script>


</html>
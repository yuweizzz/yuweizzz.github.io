<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://yuweizzz.github.io/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/github.min.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/github-style.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/light.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/dark.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/syntax.css' />
    <title>设置 mysql 主从复制 - Wei&#39;s blog</title>
    
    <link rel="icon" type="image/x-icon" href='/images/favicon.svg'>
    
    <meta name="theme-color" content="#1e2327">

    
    <meta name="description"
  content="基于已有运行的 mysql 主实例，搭建新的 mysql 从实例，设置主从复制。
" />
<meta name="keywords"
  content='blog, google analytics' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://yuweizzz.github.io/post/set_up_mysql_master_slave_replication/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="设置 mysql 主从复制 - Wei&#39;s blog" />
<meta name="twitter:description"
  content="基于已有运行的 mysql 主实例，搭建新的 mysql 从实例，设置主从复制。
" />
<meta name="twitter:site" content="https://yuweizzz.github.io/" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://yuweizzz.github.io/">


<meta property="og:type" content="article" />
<meta property="og:title" content="设置 mysql 主从复制 - Wei&#39;s blog">
<meta property="og:description"
  content="基于已有运行的 mysql 主实例，搭建新的 mysql 从实例，设置主从复制。
" />
<meta property="og:url" content="https://yuweizzz.github.io/post/set_up_mysql_master_slave_replication/" />
<meta property="og:site_name" content="设置 mysql 主从复制" />
<meta property="og:image"
  content="https://yuweizzz.github.io/">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2025-07-22 14:45:48 &#43;0000 UTC" />











  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-RFSQDKSFR1"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-RFSQDKSFR1');
        }
      </script>
    
  




</head>

<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://yuweizzz.github.io/">
        <img class="octicon" height="32" width="32" src="/images/github-mark-white.png">
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd" d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          
          <form target="_blank" id="search-form" action="" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
            </label>
          </form>
          
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://yuweizzz.github.io/">
        <img class="octicon octicon-mark-github v-align-middle" height="32" width="32" src="/images/github-mark-white.png">
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>

  <div id="search-result" class="container-lg px-3 new-discussion-timeline" style="display: none;">
</div>

  
<div class="application-main">
  <div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://yuweizzz.github.io/">
                  <img class=" avatar-user"
                    src="https://yuweizzz.github.io/images/avatar.png"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://yuweizzz.github.io/">Wei</a>
                  </span>
                  <span class="path-divider">/</span>
                  <strong class="css-truncate css-truncate-target mr-1" style="max-width: 410px">
                    <a href="https://yuweizzz.github.io/post/set_up_mysql_master_slave_replication/">设置 mysql 主从复制</a>
                  </strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Tue, 22 Jul 2025 14:45:48 &#43;0000"
                    class="no-wrap">
                    Tue, 22 Jul 2025 14:45:48 &#43;0000</relative-time>

                  
                  <span class="file-info-divider"></span>
                  Modified <relative-time datetime="Mon, 22 Sep 2025 07:24:47 &#43;0000"
                    class="no-wrap">
                    Mon, 22 Sep 2025 07:24:47 &#43;0000</relative-time>
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div id="post-header" class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style="z-index: 2">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    
                    <summary id="toc-toggle" onclick="clickToc()" class="btn btn-octicon m-0 mr-2 p-2">
                      <svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered">
                        <path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zM3 8a1 1 0 11-2 0 1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"></path>
                      </svg>
                    </summary>
                    <details-menu class="SelectMenu" id="toc-details" style="display: none;">
                      <div class="SelectMenu-modal rounded-3 mt-1" style="max-height: 340px;">
                        <div class="SelectMenu-list SelectMenu-list--borderless p-2" style="overscroll-behavior: contain;" id="toc-list">
                        </div>
                      </div>
                    </details-menu>
                      1061 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                    
                    <a class="muted-link mr-3" href="/tags/mysql">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      mysql
                    </a>
                    
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5" style="z-index: 1">
                <article class="markdown-body entry-content container-lg"><p>基于已有运行的 mysql 主实例，搭建新的 mysql 从实例，设置主从复制。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                       <span class="o">(</span>@@<span class="o">)</span> <span class="o">(</span>  <span class="o">)</span> <span class="o">(</span>@<span class="o">)</span>  <span class="o">(</span> <span class="o">)</span>  @@    <span class="o">()</span>    @     O     @     O      @
</span></span><span class="line"><span class="cl">                                  <span class="o">(</span>   <span class="o">)</span>
</span></span><span class="line"><span class="cl">                              <span class="o">(</span>@@@@<span class="o">)</span>
</span></span><span class="line"><span class="cl">                           <span class="o">(</span>    <span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                         <span class="o">(</span>@@@<span class="o">)</span>
</span></span><span class="line"><span class="cl">                       <span class="o">====</span>        ________                ___________
</span></span><span class="line"><span class="cl">                   _D _<span class="p">|</span>  <span class="p">|</span>_______/        <span class="se">\_</span>_I_I_____<span class="o">===</span>__<span class="p">|</span>_________<span class="p">|</span>
</span></span><span class="line"><span class="cl">                    <span class="p">|</span><span class="o">(</span>_<span class="o">)</span>---  <span class="p">|</span>   H<span class="se">\_</span>_______/ <span class="p">|</span>   <span class="p">|</span>        <span class="o">=</span><span class="p">|</span>___ ___<span class="p">|</span>      _________________
</span></span><span class="line"><span class="cl">                    /     <span class="p">|</span>  <span class="p">|</span>   H  <span class="p">|</span>  <span class="p">|</span>     <span class="p">|</span>   <span class="p">|</span>         <span class="o">||</span>_<span class="p">|</span> <span class="p">|</span>_<span class="o">||</span>     _<span class="p">|</span>                <span class="se">\_</span>____A
</span></span><span class="line"><span class="cl">                   <span class="p">|</span>      <span class="p">|</span>  <span class="p">|</span>   H  <span class="p">|</span>__--------------------<span class="p">|</span> <span class="o">[</span>___<span class="o">]</span> <span class="p">|</span>   <span class="o">=</span><span class="p">|</span>                        <span class="p">|</span>
</span></span><span class="line"><span class="cl">                   <span class="p">|</span> ________<span class="p">|</span>___H__/__<span class="p">|</span>_____/<span class="o">[][]</span>~<span class="se">\_</span>______<span class="p">|</span>       <span class="p">|</span>   -<span class="p">|</span>                        <span class="p">|</span>
</span></span><span class="line"><span class="cl">                   <span class="p">|</span>/ <span class="p">|</span>   <span class="p">|</span>-----------I_____I <span class="o">[][]</span> <span class="o">[]</span>  D   <span class="p">|</span><span class="o">=======</span><span class="p">|</span>____<span class="p">|</span>________________________<span class="p">|</span>_
</span></span><span class="line"><span class="cl">                 __/ <span class="o">=</span><span class="p">|</span> o <span class="p">|</span><span class="o">=</span>-~O<span class="o">=====</span><span class="nv">O</span><span class="o">=====</span><span class="nv">O</span><span class="o">=====</span>O<span class="se">\ </span>____Y___________<span class="p">|</span>__<span class="p">|</span>__________________________<span class="p">|</span>_
</span></span><span class="line"><span class="cl">                  <span class="p">|</span>/-<span class="o">=</span><span class="p">|</span>___<span class="p">|</span><span class="o">=</span>    <span class="o">||</span>    <span class="o">||</span>    <span class="o">||</span>    <span class="p">|</span>_____/~<span class="se">\_</span>__/          <span class="p">|</span>_D__D__D_<span class="p">|</span>  <span class="p">|</span>_D__D__D_<span class="p">|</span>
</span></span><span class="line"><span class="cl">                   <span class="se">\_</span>/      <span class="se">\_</span>_/  <span class="se">\_</span>_/  <span class="se">\_</span>_/  <span class="se">\_</span>_/      <span class="se">\_</span>/               <span class="se">\_</span>/   <span class="se">\_</span>/    <span class="se">\_</span>/   <span class="se">\_</span>/
</span></span></code></pre></div><p>目前线上运行着一个独立的 mysql 8.0 实例，需要新增一个只读的从实例来做分担主库的压力，同时作为主库的后备实例。这个实例已经开启了 binlog 日志，但是没有使用 GTID 模式。</p>
<p>新建的从实例的配置文件参考：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># mysql.conf</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>mysqld<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">datadir</span> <span class="o">=</span> /opt/mysql/
</span></span><span class="line"><span class="cl">pid-file <span class="o">=</span> /var/run/mysqld/mysqld.pid
</span></span><span class="line"><span class="cl"><span class="nv">socket</span> <span class="o">=</span> /var/run/mysqld/mysqld.sock
</span></span><span class="line"><span class="cl">log-error <span class="o">=</span> /var/log/mysql/error.log
</span></span><span class="line"><span class="cl">bind-address <span class="o">=</span> 0.0.0.0
</span></span><span class="line"><span class="cl">default-time-zone <span class="o">=</span> <span class="s1">&#39;+08:00&#39;</span>
</span></span><span class="line"><span class="cl">log-bin <span class="o">=</span> mysql-bin
</span></span><span class="line"><span class="cl"><span class="c1"># 这里的 server-id 应该使用和主实例不同的值</span>
</span></span><span class="line"><span class="cl">server-id <span class="o">=</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="c1"># character-set-server = utf8mb4</span>
</span></span><span class="line"><span class="cl"><span class="c1"># collation-server = utf8mb4_general_ci</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">binlog_format</span> <span class="o">=</span> ROW
</span></span><span class="line"><span class="cl"><span class="nv">slow_query_log</span> <span class="o">=</span> ON
</span></span><span class="line"><span class="cl"><span class="nv">slow_query_log_file</span> <span class="o">=</span> /var/log/mysql/mysqlslow.log
</span></span><span class="line"><span class="cl"><span class="nv">lower_case_table_names</span> <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nv">max_connections</span> <span class="o">=</span> <span class="m">2000</span>
</span></span><span class="line"><span class="cl"><span class="nv">wait_timeout</span> <span class="o">=</span> <span class="m">86400</span>
</span></span><span class="line"><span class="cl"><span class="nv">max_connect_errors</span> <span class="o">=</span> <span class="m">100</span>
</span></span><span class="line"><span class="cl"><span class="nv">max_allowed_packet</span> <span class="o">=</span> 1024m
</span></span><span class="line"><span class="cl"><span class="c1"># gtid_mode = ON</span>
</span></span><span class="line"><span class="cl"><span class="c1"># enforce_gtid_consistency = ON</span>
</span></span></code></pre></div><h2 id="基于-binlog-position-进行同步">基于 binlog position 进行同步</h2>
<p>首先对主实例进行备份：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mysqldump --single-transaction <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --flush-logs <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --master-data<span class="o">=</span><span class="m">2</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --databases db1 db2 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -u root -p &gt; replica.sql
</span></span><span class="line"><span class="cl"><span class="c1"># --single-transaction 在单个事务中完成备份，避免锁表</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --master-data=2 以注释形式将 binlog 文件位置和对应点位记录到备份文件中</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --flush-logs 截断并重新写入新的 binlog</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 以下是一些没有用到的 mysqldump 选项，可以根据实际情况决定是否使用：</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --triggers 同时备份触发器</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --routines 同时备份存储过程和存储函数</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --events 同时备份事件</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --all-databases 备份所有的数据库</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 在数据库中新建用于同步的用户，添加对应的权限</span>
</span></span><span class="line"><span class="cl">create user <span class="s1">&#39;replica&#39;</span>@<span class="s1">&#39;%&#39;</span> identified by <span class="s1">&#39;replica_password&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">grant replication client, replication slave on *.* to <span class="s1">&#39;replica&#39;</span>@<span class="s1">&#39;%&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">flush privileges<span class="p">;</span>
</span></span></code></pre></div><p>在启动从实例之后，导入备份并设置主实例信息：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 导入备份</span>
</span></span><span class="line"><span class="cl"><span class="nb">source</span> replica.sql<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 重置当前 binlog ，在需要保留本地 binlog 的情况下，可以省略这一步</span>
</span></span><span class="line"><span class="cl">reset master<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 设置主实例信息，其中的 binlog 文件位置和点位应该在 replica.sql 中获取</span>
</span></span><span class="line"><span class="cl">change master to
</span></span><span class="line"><span class="cl">  <span class="nv">master_host</span><span class="o">=</span><span class="s1">&#39;10.0.0.1&#39;</span>,
</span></span><span class="line"><span class="cl">  <span class="nv">master_user</span><span class="o">=</span><span class="s1">&#39;replica&#39;</span>,
</span></span><span class="line"><span class="cl">  <span class="nv">master_password</span><span class="o">=</span><span class="s1">&#39;replica_password&#39;</span>,
</span></span><span class="line"><span class="cl">  <span class="nv">master_log_file</span><span class="o">=</span><span class="s1">&#39;mysql-bin.000100&#39;</span>,
</span></span><span class="line"><span class="cl">  <span class="nv">master_log_pos</span><span class="o">=</span>157<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 启动同步</span>
</span></span><span class="line"><span class="cl">start slave<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 将当前实例设置为只读</span>
</span></span><span class="line"><span class="cl"><span class="nb">set</span> global <span class="nv">read_only</span><span class="o">=</span>ON<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 提升当前实例为独立节点</span>
</span></span><span class="line"><span class="cl"><span class="c1"># stop slave;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># reset slave all;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># set global read_only=OFF;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 从实例因为错误而停止同步时，可以根据实际情况决定是否跳过错误事件</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 以下操作可以跳过一次同步错误</span>
</span></span><span class="line"><span class="cl"><span class="c1"># set gloabl sql_slave_skip_counter = 1;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># start slave;</span>
</span></span></code></pre></div><p>因为目前的架构就是最简单的单主单从，直接使用 binlog 点位就可以实现同步。</p>
<h2 id="基于-gtid-进行同步">基于 GTID 进行同步</h2>
<p>在涉及到单主多从或者更复杂的情况下，一般会使用 GTID 模式，这样会需要所有的实例都开启 GTID 模式，通过配置文件中的 <code>gtid_mode</code> 和 <code>enforce_gtid_consistency</code> 进行控制。</p>
<p>首先对主实例进行备份：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mysqldump <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --single-transaction <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --flush-logs <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --master-data<span class="o">=</span><span class="m">2</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --databases db1 db2 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --set-gtid-purged<span class="o">=</span>on <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -u root -p &gt; replica.sql
</span></span><span class="line"><span class="cl"><span class="c1"># 对比前述的备份命令，额外设置 --set-gtid-purged=on 选项</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --set-gtid-purged=on 额外设置两个操作命令：</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 临时关闭 binlog ，所以本次 sql 导入时不会产生 binlog</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 设置 GTID_PURGED 变量，标记已经被删除了 binlog 的事务，这个值同时也是从实例应该开始同步的事务起点</span>
</span></span></code></pre></div><p>在启动从实例之后，导入备份并设置主实例信息：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 提前重置 binlog ，因为备份 sql 会涉及 GTID_PURGED 变量设置</span>
</span></span><span class="line"><span class="cl">reset master<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nb">source</span> replica.sql<span class="p">;</span>
</span></span><span class="line"><span class="cl">change master to
</span></span><span class="line"><span class="cl">  <span class="nv">master_host</span><span class="o">=</span><span class="s1">&#39;10.0.0.1&#39;</span>,
</span></span><span class="line"><span class="cl">  <span class="nv">master_user</span><span class="o">=</span><span class="s1">&#39;replica&#39;</span>,
</span></span><span class="line"><span class="cl">  <span class="nv">master_password</span><span class="o">=</span><span class="s1">&#39;replica_password&#39;</span>,
</span></span><span class="line"><span class="cl">  <span class="nv">master_auto_position</span><span class="o">=</span>1<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 不需要再额外指定 binlog 点位，通过 master_auto_position 自动定位</span>
</span></span><span class="line"><span class="cl">start slave<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nb">set</span> global <span class="nv">read_only</span><span class="o">=</span>ON<span class="p">;</span>
</span></span></code></pre></div><p>这两种同步方式都使用到了 <code>reset master</code> ，需要注意这其实是非常危险的操作，由于我们是在全新实例上运行，所以使用这个命令影响不大，但是在已有数据的情况下，一定要慎重。</p></article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
<script type="application/javascript" src='https://yuweizzz.github.io/js/toc.js'></script>
<link rel="stylesheet" href='https://yuweizzz.github.io/css/toc.css' />

  
</div>

  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://yuweizzz.github.io/">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>
</body>

<script type="application/javascript" src="https://yuweizzz.github.io/js/github-style.js"></script>





<script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
<script type="application/javascript" src='https://yuweizzz.github.io/js/search.js'></script>


<script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
<script type="text/javascript" src="https://yuweizzz.github.io/js/CustomLive2D.js"></script>


</html>
<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://yuweizzz.github.io/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/github.min.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/github-style.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/light.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/dark.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/syntax.css' />
    <title>TLS 协议工作原理 - Wei&#39;s blog</title>
    
    <link rel="icon" type="image/x-icon" href='/images/github.png'>
    
    <meta name="theme-color" content="#1e2327">

    
    <meta name="description"
  content="这篇笔记用来记录 TLS 协议的工作原理及其相关计算机密码学的知识。
" />
<meta name="keywords"
  content='blog, google analytics' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://yuweizzz.github.io/post/knowledge_about_tls/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="TLS 协议工作原理 - Wei&#39;s blog" />
<meta name="twitter:description"
  content="这篇笔记用来记录 TLS 协议的工作原理及其相关计算机密码学的知识。
" />
<meta name="twitter:site" content="https://yuweizzz.github.io" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://yuweizzz.github.io">


<meta property="og:type" content="article" />
<meta property="og:title" content="TLS 协议工作原理 - Wei&#39;s blog">
<meta property="og:description"
  content="这篇笔记用来记录 TLS 协议的工作原理及其相关计算机密码学的知识。
" />
<meta property="og:url" content="https://yuweizzz.github.io/post/knowledge_about_tls/" />
<meta property="og:site_name" content="TLS 协议工作原理" />
<meta property="og:image"
  content="https://yuweizzz.github.io">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2022-03-26 13:22:45 &#43;0000 UTC" />











<script async src="https://www.googletagmanager.com/gtag/js?id=UA-174929827-1"></script>
<script>
  if (navigator.doNotTrack !== '1') {
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-174929827-1');
  }
</script>


</head>

<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://yuweizzz.github.io">
        <svg class="octicon" height="32" viewBox="0 0 16 16" version="1.1" width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd"
            d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          <form target="_blank" action="https://www.google.com/search" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
              <input type="hidden" name="q" value="site:https://yuweizzz.github.io">
            </label>
          </form>
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://yuweizzz.github.io">
        <svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" version="1.1"
          width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>
  
<div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://yuweizzz.github.io">
                  <img class=" avatar-user"
                    src="https://yuweizzz.github.io/images/avatar.png"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://yuweizzz.github.io">Wei</a></span><span
                    class="path-divider">/</span><strong class="css-truncate-target mr-1" style="max-width: 410px"><a
                      href="https://yuweizzz.github.io/post/knowledge_about_tls/">TLS 协议工作原理</a></strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Sat, 26 Mar 2022 13:22:45 &#43;0000"
                    class="no-wrap">
                    Sat, 26 Mar 2022 13:22:45 &#43;0000</relative-time>

                  
                  <span class="file-info-divider"></span>
                  Modified <relative-time datetime="Sun, 17 Jul 2022 16:03:45 &#43;0000"
                    class="no-wrap">
                    Sun, 17 Jul 2022 16:03:45 &#43;0000</relative-time>
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div id="post-header" class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style="z-index: 2">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    
                    <summary id="toc-toggle" onclick="clickToc()" class="btn btn-octicon m-0 mr-2 p-2">
                      <svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered">
                        <path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zM3 8a1 1 0 11-2 0 1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"></path>
                      </svg>
                    </summary>
                    <details-menu class="SelectMenu" id="toc-details" style="display: none;">
                      <div class="SelectMenu-modal rounded-3 mt-1" style="max-height: 340px;">
                        <div class="SelectMenu-list SelectMenu-list--borderless p-2" style="overscroll-behavior: contain;" id="toc-list">
                        </div>
                      </div>
                    </details-menu>
                      3802 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                    
                    <a class="muted-link mr-3" href="/tags/linux">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      Linux
                    </a>
                    
                    <a class="muted-link mr-3" href="/tags/openssl">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      OpenSSL
                    </a>
                    
                    <a class="muted-link mr-3" href="/tags/tls">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      TLS
                    </a>
                    
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5" style="z-index: 1">
                <article class="markdown-body entry-content container-lg"><p>这篇笔记用来记录 TLS 协议的工作原理及其相关计算机密码学的知识。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">
                                       <span class="o">(</span>@@<span class="o">)</span> <span class="o">(</span>  <span class="o">)</span> <span class="o">(</span>@<span class="o">)</span>  <span class="o">(</span> <span class="o">)</span>  @@    <span class="o">()</span>    @     O     @     O      @
                                  <span class="o">(</span>   <span class="o">)</span>
                              <span class="o">(</span>@@@@<span class="o">)</span>
                           <span class="o">(</span>    <span class="o">)</span>

                         <span class="o">(</span>@@@<span class="o">)</span>
                       <span class="o">====</span>        ________                ___________
                   _D _<span class="p">|</span>  <span class="p">|</span>_______/        <span class="se">\_</span>_I_I_____<span class="o">===</span>__<span class="p">|</span>_________<span class="p">|</span>
                    <span class="p">|</span><span class="o">(</span>_<span class="o">)</span>---  <span class="p">|</span>   H<span class="se">\_</span>_______/ <span class="p">|</span>   <span class="p">|</span>        <span class="o">=</span><span class="p">|</span>___ ___<span class="p">|</span>      _________________
                    /     <span class="p">|</span>  <span class="p">|</span>   H  <span class="p">|</span>  <span class="p">|</span>     <span class="p">|</span>   <span class="p">|</span>         <span class="o">||</span>_<span class="p">|</span> <span class="p">|</span>_<span class="o">||</span>     _<span class="p">|</span>                <span class="se">\_</span>____A
                   <span class="p">|</span>      <span class="p">|</span>  <span class="p">|</span>   H  <span class="p">|</span>__--------------------<span class="p">|</span> <span class="o">[</span>___<span class="o">]</span> <span class="p">|</span>   <span class="o">=</span><span class="p">|</span>                        <span class="p">|</span>
                   <span class="p">|</span> ________<span class="p">|</span>___H__/__<span class="p">|</span>_____/<span class="o">[][]</span>~<span class="se">\_</span>______<span class="p">|</span>       <span class="p">|</span>   -<span class="p">|</span>                        <span class="p">|</span>
                   <span class="p">|</span>/ <span class="p">|</span>   <span class="p">|</span>-----------I_____I <span class="o">[][]</span> <span class="o">[]</span>  D   <span class="p">|</span><span class="o">=======</span><span class="p">|</span>____<span class="p">|</span>________________________<span class="p">|</span>_
                 __/ <span class="o">=</span><span class="p">|</span> o <span class="p">|</span><span class="o">=</span>-~O<span class="o">=====</span><span class="nv">O</span><span class="o">=====</span><span class="nv">O</span><span class="o">=====</span>O<span class="se">\ </span>____Y___________<span class="p">|</span>__<span class="p">|</span>__________________________<span class="p">|</span>_
                  <span class="p">|</span>/-<span class="o">=</span><span class="p">|</span>___<span class="p">|</span><span class="o">=</span>    <span class="o">||</span>    <span class="o">||</span>    <span class="o">||</span>    <span class="p">|</span>_____/~<span class="se">\_</span>__/          <span class="p">|</span>_D__D__D_<span class="p">|</span>  <span class="p">|</span>_D__D__D_<span class="p">|</span>
                   <span class="se">\_</span>/      <span class="se">\_</span>_/  <span class="se">\_</span>_/  <span class="se">\_</span>_/  <span class="se">\_</span>_/      <span class="se">\_</span>/               <span class="se">\_</span>/   <span class="se">\_</span>/    <span class="se">\_</span>/   <span class="se">\_</span>/

</code></pre></div><h2 id="计算机密码学算法">计算机密码学算法</h2>
<p>TLS 协议的是结合了多种计算机密码学算法实现的，它用来实现传输过程中的数据安全。</p>
<p>在计算机密码学中，经常使用的有对称加密算法，非对称加密算法和散列算法。</p>
<p>对称加密算法用来加密数据，它的特点是数据加密和解密需要使用相同的密钥，所以密钥泄露时，加密数据就会被轻松破解，实际应用的对称加密算法有 DES 和 AES 。</p>
<p>非对称加密算法则更特殊，使用时需要预先生成密钥对，在通信时保留私钥，把公钥分发给对方，将信息使用私钥进行加密，这样对方就可以使用公钥对加密信息进行解密。这种加密方式的特点在于使用公钥加密后，只能通过对应的私钥进行解密，保证了只有通信双方能获取到加密信息。实际应用的非对称加密算法有 RSA 和 DSA 。</p>
<p>散列算法也就是哈希 hash 算法，主要用来验证数据的完整性。它的特点是对不定长的数据总是可以计算出定长的散列值，并且这个过程是单向不可逆的。即使是很小的数据改动，散列值总是不相同的。我们利用这部分散列信息来验证的数据的完整性，实际应用的散列算法有 MD5 和 SHA 。</p>
<h2 id="如何实现数据安全">如何实现数据安全</h2>
<p>在前面密码学的理论支持下，我们需要做到以下三点来确保数据安全：</p>
<ol>
<li>数据不被泄露。</li>
<li>数据是真实的，未被篡改破坏的。</li>
<li>数据是来源可靠的。</li>
</ol>
<p>实现第一点需要对数据进行加密，基于前面的理论，我们应该优先使用的是非对称加密算法，但实际中是结合了两种加密算法来实现。</p>
<p>实现第二点需要对数据进行校验，在实际应用中，我们通过散列算法计算出散列值，这个值通常称为信息摘要，再通过非对称加密算法对信息摘要进行加密，得到的加密信息称为数字签名。在验证数据真实完整性时更多是使用加密后的数字签名，而不是单纯的信息摘要。</p>
<p>由于我们并无法直接确认通信目标就是可信的，为了实现第三点，在这里引出了证书的概念。</p>
<p>虽然我们无法保证通信方是百分百可信的，但是我们可以选择性地信任某些权威机构，并委托这些机构去认证通信来源，如果这些机构认可通信来源，就会给它颁发证书。当我们与对方通信时，如果它出示的证书来自我们信任的权威机构，那么我们就可以信任对方并与之通信。</p>
<p>权威机构 Certificate Authority 自身也需要证书，并且我们需要主动信任 CA 证书，由这个 CA 签发的系列证书才能被正常信任，各大认证机构的 CA 证书通常已经内置于操作系统，随意信任来历不明的 CA 证书是非常危险的。</p>
<p>在三点要求满足的情况下，我们可以认为已经实现了数据安全。</p>
<h2 id="生成-ca-证书和-tls-证书">生成 CA 证书和 TLS 证书</h2>
<p>前面我们已经描述了证书在通信过程中的重要地位，其中 CA 机构自身使用的证书和签发出去的 TLS 证书是略有区别的，但它们都遵循 X.509 标准。</p>
<p>CA 证书包括了该机构的组织信息，持有的公钥和信息的数字签名等，我们需要 CA 证书的重要原因是验证时需要使用 CA 证书中的公钥去验证 TLS 证书的数字签名。</p>
<p>TLS 证书包括了该站点的组织信息，域名信息，站点所使用的公钥和信息的数字签名等， TLS 证书的公钥会用于和使用该证书的站点通信。</p>
<p>签发证书的通常过程是这样的：</p>
<ol>
<li>域名拥有者将域名信息，申请者所属组织等必要信息生成签发证书的请求，给到具体的 CA 机构。</li>
<li>CA 对签发请求的信息生成信息摘要，并使用 CA 的私钥生成数字签名，再附上 CA 自身的信息，生成证书文件。</li>
</ol>
<p>在实际应用中，我们可以直接自行签发 TLS 证书，也可以通过自建 CA 来签发需要的 TLS 证书。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 自签名 TLS 证书</span>

<span class="c1"># 生成私钥</span>
$ openssl genrsa -out key.pri <span class="m">2048</span>
<span class="c1"># 以 www.ibm.com 为例，生成证书签发请求</span>
$ openssl req -new -sha256 -key key.pri <span class="se">\
</span><span class="se"></span> -subj <span class="s2">&#34;/C=US/ST=IL/L=Chicago/O=IBM Corporation/OU=IBM Software Group/CN=www.ibm.com&#34;</span> -out request.csr
<span class="c1"># 生成自签证书，由于它不会被自动信任， signkey 可以重新生成或者直接沿用自身的私钥</span>
$ openssl x509 -req -sha256 -days <span class="m">365</span> -in request.csr -signkey key.pri -out ibm.crt
</code></pre></div><p>自签名意味着自身就是签发的 CA 机构，在访问使用自签名 TLS 证书的站点时，通常会显示证书不受信任的提示，手动把这个自签名证书加入到操作系统的信任链中后这个提示就不会再出现了。但是将单一站点的 TLS 证书加入到信任链中是非常少见的操作，一般只会直接信任 CA 证书。</p>
<p>所以如果需要多个自签 TLS 证书，则自建 CA 会更方便，它与自签名 TLS 的区别在于不随意使用私钥去签名，而是固定一对密钥，把它持续用于后续 TLS 证书的签发，并且将固定公钥生成 CA 证书，那么只需要信任 CA 证书就可以自动信任它所签发的 TLS 证书。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 自建 CA</span>

<span class="c1"># 生成私钥</span>
$ openssl genrsa -out key.pri <span class="m">2048</span>
<span class="c1"># 生成证书签发请求</span>
$ openssl req -new -sha256 -key key.pri <span class="se">\
</span><span class="se"></span> -subj <span class="s2">&#34;/C=US/ST=IL/L=Chicago/O=IBM Corporation/OU=IBM Software Group/CN=IBM Root Certificate&#34;</span> -out request.csr
<span class="c1"># 生成 CA 证书</span>
$ openssl x509 -req -sha256 -days <span class="m">365</span> -in request.csr -signkey key.pri -out CA.crt

<span class="c1"># 使用自建 CA 签发 TLS 证书</span>

<span class="c1"># 站点生成证书签发请求</span>
$ openssl genrsa -out server_key.pri <span class="m">2048</span>
<span class="c1"># 这里可以通过配置多个 CN ，也可以将单个 CN 指定类似 *.software.ibm.com 的泛解析来满足多域名的情况</span>
$ openssl req -new -sha256 -key server_key.pri <span class="se">\
</span><span class="se"></span> -subj <span class="s2">&#34;/C=US/ST=IL/L=Chicago/O=IBM Corporation/OU=IBM Software Group/CN=software.ibm.com&#34;</span> -out request.csr
<span class="c1"># CA 处理签发请求，生成证书</span>
$ openssl x509 -req -sha256 -days <span class="m">365</span> -in request.csr -CA CA.crt -CAkey key.pri -CAcreateserial -out software.crt
</code></pre></div><p>在 golang 1.15 之后的版本，进行 tls 握手时发生报错 <code>&quot;x509: certificate relies on legacy Common Name field, use SANs or temporarily enable Common Name matching with GODEBUG=x509ignoreCN=0&quot;</code> 是因为当前使用的证书依赖于 CN 作为域名绑定，需要使用 x509 拓展字段 Subject Alternative Name 才能进行正常验证，也就是报错信息所述的 SAN 。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 生成 SAN 证书</span>

<span class="c1"># 前序步骤和使用 CN 的证书相似</span>
<span class="c1"># 生成私钥</span>
$ openssl genrsa -out server_key.pri <span class="m">2048</span>
<span class="c1"># 生成证书签发请求</span>
$ openssl req -new -sha256 -key server_key.pri <span class="se">\
</span><span class="se"></span> -subj <span class="s2">&#34;/C=US/ST=IL/L=Chicago/O=IBM Corporation/OU=IBM Software Group/CN=software.ibm.com&#34;</span> -out request.csr
<span class="c1"># 使用 CA 处理签发请求，生成 SAN 证书</span>
$ openssl x509 -req -sha256 -days <span class="m">365</span> -in request.csr -CA CA.crt -CAkey key.pri -CAcreateserial <span class="se">\
</span><span class="se"></span> -extfile &lt;<span class="o">(</span><span class="nb">printf</span> <span class="s2">&#34;subjectAltName=DNS:www.software.ibm.com,DNS:software.ibm.com,IP:1.1.1.1&#34;</span><span class="o">)</span> -out software.crt

<span class="c1"># 如果是高版本的 openssl 可以尝试这样做</span>
$ openssl x509 -req -sha256 -days <span class="m">365</span> -in request.csr -CA CA.crt -CAkey key.pri -CAcreateserial <span class="se">\
</span><span class="se"></span> -addext <span class="s2">&#34;subjectAltName=subjectAltName=DNS:www.software.ibm.com,DNS:software.ibm.com,IP:1.1.1.1&#34;</span> -out software.crt

<span class="c1"># 可以看到实际的签发方式和使用 CN 的证书类似，但是使用了 x509 ext 字段，这样可以扩展证书的泛用性，匹配多个域名和 IP 地址</span>
<span class="c1"># 签发之后就可以在证书的 X509v3 extensions 看到这部分信息</span>
</code></pre></div><p>通过信任上述例子中的 <code>CA.crt</code> ，后续如 <code>software.crt</code> 等由 <code>CA.crt</code> 签发的证书都是自动授信的。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 在 CentOS 中添加信任 CA </span>
$ mv TrustCA.crt /etc/pki/ca-trust/source/anchors/
$ update-ca-trust

<span class="c1"># 执行 update-ca-trust 后应该可以在 ca-bundle.crt 的文件开头看到新增的信任 CA</span>
$ cat /etc/pki/tls/certs/ca-bundle.crt
</code></pre></div><p>以下是 <code>openssl</code> 的一些常用命令以供参考：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 查看证书生成请求</span>
$ openssl req -in request.csr -text -noout

<span class="c1"># 查看证书内容信息</span>
$ openssl x509 -in x509.crt -text -noout

<span class="c1"># 生成 4096 bit 长度的 rsa 私钥，可选的长度还有 2048 ， 1024 ， 512</span>
$ openssl genrsa -out key.pri <span class="m">4096</span>
<span class="c1"># 检查生成的私钥</span>
$ openssl rsa -in key.pri -check

<span class="c1"># 提取对应的 rsa 公钥</span>
$ openssl rsa -in key.pri -pubout -out key.pub

<span class="c1"># 对文件进行数字签名</span>
$ openssl dgst -sha256 -out sign.txt -sign key.pri file

<span class="c1"># 使用公钥和私钥分别验证数字签名</span>
$ openssl dgst -sha256 -prverify key.pri -signature sign.txt file
$ openssl dgst -sha256 -verify key.pub -signature sign.txt file
</code></pre></div><h2 id="tls-协议握手过程">TLS 协议握手过程</h2>
<p>在 HTTP 通信之前，先在通信双方之间通过 TLS 协议建立一条安全通道，后续的 HTTP 通信内容就不再是明文的，只有通信双方才能解读这些信息，这也就是常说的 HTTPS 协议。</p>
<p>现有的主流 TLS 版本是 TLS v1.2 和 TLS v1.3 ，低于这两个版本的协议安全性比较低，不建议使用。</p>
<pre><code>TLS v1.2 的握手过程:

      Client                                               Server

      ClientHello                  --------&gt;
                                                      ServerHello
                                                     Certificate*
                                               ServerKeyExchange*
                                              CertificateRequest*
                                   &lt;--------      ServerHelloDone
      Certificate*
      ClientKeyExchange
      CertificateVerify*
      [ChangeCipherSpec]
      Finished                     --------&gt;
                                               [ChangeCipherSpec]
                                   &lt;--------             Finished
      Application Data             &lt;-------&gt;     Application Data

   * Indicates optional or situation-dependent messages that are not
   always sent.

TLS v1.3 的握手过程:

       Client                                           Server

Key  ^ ClientHello
Exch | + key_share*
     | + signature_algorithms*
     | + psk_key_exchange_modes*
     v + pre_shared_key*       --------&gt;
                                                  ServerHello  ^ Key
                                                 + key_share*  | Exch
                                            + pre_shared_key*  v
                                        {EncryptedExtensions}  ^  Server
                                        {CertificateRequest*}  v  Params
                                               {Certificate*}  ^
                                         {CertificateVerify*}  | Auth
                                                   {Finished}  v
                               &lt;--------  [Application Data*]
     ^ {Certificate*}
Auth | {CertificateVerify*}
     v {Finished}              --------&gt;
       [Application Data]      &lt;-------&gt;  [Application Data]

         +  Indicates noteworthy extensions sent in the
            previously noted message.

         *  Indicates optional or situation-dependent
            messages/extensions that are not always sent.

         {} Indicates messages protected using keys
            derived from a [sender]_handshake_traffic_secret.

         [] Indicates messages protected using keys
            derived from [sender]_application_traffic_secret_N.

</code></pre><p>虽然两个主流 TLS 版本的握手过程是略有差异的，但它们的核心过程是一致的，我们可以通过 TLS v1.2 的握手过程来学习：</p>
<ol>
<li>客户端发起 ClientHello ， ClientHello 主要内容是时间戳，随机数，算法协议簇等握手需要的信息。</li>
<li>服务端接收 ClientHello 后，会返回 ServerHello ，主要内容是时间戳，随机数，确定使用的算法协议等信息。</li>
<li>通常地，服务端证书还会和 ServerHello 一起返回给客户端。</li>
<li>除了证书，服务端还会发送 ServerKeyExchange ，这个部分主要内容是后续对称密钥协商所需要的参数，具体内容会由使用的协商算法所决定，如果是 RSA 协商，这个步骤是可以省略的。</li>
<li>客户端验证证书的有效性，如果证书成功通过验证，假设使用 RSA 作为协商算法，客户端将生成新的随机数 Pre-Master Key ，然后通过证书中的公钥加密，发送 ClientKeyExchange 给到服务端。</li>
<li>客户端完成 ClientKeyExchange ，会将 Pre-Master Key ， ClientHello 中随机数， ServerHello 中随机数三者协商出对称加密密钥，完成后发送 ChangeCipherSpec 。</li>
<li>服务端拿到加密的 Pre-Master Key ，可以通过私钥进行解密，然后结合三个随机数，通过前面定好的协商算法计算出对称加密密钥，完成后它也应该向客户端发送 ChangeCipherSpec 。</li>
<li>双方均切换至对称密钥加密，完成握手协议，切换至具体的应用协议。</li>
</ol>
<p>可以看到，整个过程是非对称加密和对称加密的组合使用，因为非对称加密有着密钥安全性的保证，但解密速度比较差，而对称加密的密钥安全性比较难保障，但加密解密速度快，握手协议交换密钥的过程完美地整合了两者的优点。</p>
<p>在 TLS v1.3 中，它基于 v1.2 做出了一些协议优化，最直观的优化点在于省去 ChangeCipherSpec 过程，第二个优化点是 ClientKeyExchange 过程，主要改进内容在于对称密钥的协商算法。</p>
<p>在原有的握手协议中有 ClientHello 和 ServerHello 两个明文信息，在未改进协商算法前，如果在 ClientKeyExchange 过程，服务端的私钥已经泄露， Pre-Master Key 就可以被破获，相应的加密密钥也可以被推算出来。所以 v1.3 禁用了不安全的 RSA 协商算法，只允许使用安全的 ECDHE 协商算法，使用新算法之后，可以弃用 Pre-Master Key ，新的协商参数放在了 ClientHello 和 ServerHello 各自的扩展 key_share 中，所以可以将 KeyExchange 和 ChangeCipherSpec 过程也一并省去，直接在这两个 Hello 步骤就完成了密钥协商。</p>
<p>可以看到， TLS 握手最终是为了生成数据加密使用的对称密钥，在 v1.2 的版本中，使用 RSA 协商算法可以认为只有客户端参与了密钥的生成，其他参数都是不安全的明文信息。而 v1.3 则是改进了这一点， ECDHE 协商算法使得双方都参与到了密钥的生成中，虽然这一过程还远不止这么简单，整个握手过程还有签名验证和派生的 HKDF 密钥参与握手过程的信息加密，但整体的核心目标还是不变的，并且在此基础上提升了性能和安全性。</p>
<h2 id="总结">总结</h2>
<p>实际中的 TLS 握手过程会根据实际情况变动，并且服务端和客户端各自的握手扩展并不总是相同的，但纵观不同版本的 TLS 协议，它们的总体思路并没有特别大的变动，证书依然承载着认证的功能，而各种算法协议的改动最终也是为了生成安全的对称密钥。</p>
<p>所以只需要做到对握手过程有总览性的认知就足够了，具体算法细节可以不必过于深入了解。</p></article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
<script type="application/javascript" src='https://yuweizzz.github.io/js/toc.js'></script>
<link rel="stylesheet" href='https://yuweizzz.github.io/css/toc.css' />


  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://yuweizzz.github.io">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>
</body>

<script type="application/javascript" src="https://yuweizzz.github.io/js/github-style.js"></script>


<script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
<script type="text/javascript" src="https://yuweizzz.github.io/js/CustomLive2D.js"></script>


</html>
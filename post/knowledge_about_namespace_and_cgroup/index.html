<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://yuweizzz.github.io/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/github.min.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/github-style.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/light.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/dark.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/syntax.css' />
    <title>实现容器技术的基础：Namespace 与 Cgroup - Wei&#39;s blog</title>
    
    <link rel="icon" type="image/x-icon" href='/images/favicon.svg'>
    
    <meta name="theme-color" content="#1e2327">

    
    <meta name="description"
  content="这篇笔记用来记录 Namespace 与 Cgroup 的相关知识。
" />
<meta name="keywords"
  content='blog, google analytics' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://yuweizzz.github.io/post/knowledge_about_namespace_and_cgroup/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="实现容器技术的基础：Namespace 与 Cgroup - Wei&#39;s blog" />
<meta name="twitter:description"
  content="这篇笔记用来记录 Namespace 与 Cgroup 的相关知识。
" />
<meta name="twitter:site" content="https://yuweizzz.github.io/" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://yuweizzz.github.io/">


<meta property="og:type" content="article" />
<meta property="og:title" content="实现容器技术的基础：Namespace 与 Cgroup - Wei&#39;s blog">
<meta property="og:description"
  content="这篇笔记用来记录 Namespace 与 Cgroup 的相关知识。
" />
<meta property="og:url" content="https://yuweizzz.github.io/post/knowledge_about_namespace_and_cgroup/" />
<meta property="og:site_name" content="实现容器技术的基础：Namespace 与 Cgroup" />
<meta property="og:image"
  content="https://yuweizzz.github.io/">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2022-05-13 20:44:45 &#43;0000 UTC" />











  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-RFSQDKSFR1"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-RFSQDKSFR1');
        }
      </script>
    
  




</head>

<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://yuweizzz.github.io/">
        <img class="octicon" height="32" width="32" src="/images/github-mark-white.png">
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd" d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          <form target="_blank" action="https://www.google.com/search" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
              <input type="hidden" name="q" value="site:https://yuweizzz.github.io/">
            </label>
          </form>
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://yuweizzz.github.io/">
        <img class="octicon octicon-mark-github v-align-middle" height="32" width="32" src="/images/github-mark-white.png">
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>

  
<div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://yuweizzz.github.io/">
                  <img class=" avatar-user"
                    src="https://yuweizzz.github.io/images/avatar.png"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://yuweizzz.github.io/">Wei</a>
                  </span>
                  <span class="path-divider">/</span>
                  <strong class="css-truncate css-truncate-target mr-1" style="max-width: 410px">
                    <a href="https://yuweizzz.github.io/post/knowledge_about_namespace_and_cgroup/">实现容器技术的基础：Namespace 与 Cgroup</a>
                  </strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Fri, 13 May 2022 20:44:45 &#43;0000"
                    class="no-wrap">
                    Fri, 13 May 2022 20:44:45 &#43;0000</relative-time>

                  
                  <span class="file-info-divider"></span>
                  Modified <relative-time datetime="Sat, 27 Jul 2024 15:02:10 &#43;0000"
                    class="no-wrap">
                    Sat, 27 Jul 2024 15:02:10 &#43;0000</relative-time>
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div id="post-header" class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style="z-index: 2">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    
                    <summary id="toc-toggle" onclick="clickToc()" class="btn btn-octicon m-0 mr-2 p-2">
                      <svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered">
                        <path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zM3 8a1 1 0 11-2 0 1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"></path>
                      </svg>
                    </summary>
                    <details-menu class="SelectMenu" id="toc-details" style="display: none;">
                      <div class="SelectMenu-modal rounded-3 mt-1" style="max-height: 340px;">
                        <div class="SelectMenu-list SelectMenu-list--borderless p-2" style="overscroll-behavior: contain;" id="toc-list">
                        </div>
                      </div>
                    </details-menu>
                      4175 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                    
                    <a class="muted-link mr-3" href="/tags/container">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      Container
                    </a>
                    
                    <a class="muted-link mr-3" href="/tags/namespace">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      Namespace
                    </a>
                    
                    <a class="muted-link mr-3" href="/tags/cgroup">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      Cgroup
                    </a>
                    
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5" style="z-index: 1">
                <article class="markdown-body entry-content container-lg"><p>这篇笔记用来记录 Namespace 与 Cgroup 的相关知识。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                       <span class="o">(</span>@@<span class="o">)</span> <span class="o">(</span>  <span class="o">)</span> <span class="o">(</span>@<span class="o">)</span>  <span class="o">(</span> <span class="o">)</span>  @@    <span class="o">()</span>    @     O     @     O      @
</span></span><span class="line"><span class="cl">                                  <span class="o">(</span>   <span class="o">)</span>
</span></span><span class="line"><span class="cl">                              <span class="o">(</span>@@@@<span class="o">)</span>
</span></span><span class="line"><span class="cl">                           <span class="o">(</span>    <span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                         <span class="o">(</span>@@@<span class="o">)</span>
</span></span><span class="line"><span class="cl">                       <span class="o">====</span>        ________                ___________
</span></span><span class="line"><span class="cl">                   _D _<span class="p">|</span>  <span class="p">|</span>_______/        <span class="se">\_</span>_I_I_____<span class="o">===</span>__<span class="p">|</span>_________<span class="p">|</span>
</span></span><span class="line"><span class="cl">                    <span class="p">|</span><span class="o">(</span>_<span class="o">)</span>---  <span class="p">|</span>   H<span class="se">\_</span>_______/ <span class="p">|</span>   <span class="p">|</span>        <span class="o">=</span><span class="p">|</span>___ ___<span class="p">|</span>      _________________
</span></span><span class="line"><span class="cl">                    /     <span class="p">|</span>  <span class="p">|</span>   H  <span class="p">|</span>  <span class="p">|</span>     <span class="p">|</span>   <span class="p">|</span>         <span class="o">||</span>_<span class="p">|</span> <span class="p">|</span>_<span class="o">||</span>     _<span class="p">|</span>                <span class="se">\_</span>____A
</span></span><span class="line"><span class="cl">                   <span class="p">|</span>      <span class="p">|</span>  <span class="p">|</span>   H  <span class="p">|</span>__--------------------<span class="p">|</span> <span class="o">[</span>___<span class="o">]</span> <span class="p">|</span>   <span class="o">=</span><span class="p">|</span>                        <span class="p">|</span>
</span></span><span class="line"><span class="cl">                   <span class="p">|</span> ________<span class="p">|</span>___H__/__<span class="p">|</span>_____/<span class="o">[][]</span>~<span class="se">\_</span>______<span class="p">|</span>       <span class="p">|</span>   -<span class="p">|</span>                        <span class="p">|</span>
</span></span><span class="line"><span class="cl">                   <span class="p">|</span>/ <span class="p">|</span>   <span class="p">|</span>-----------I_____I <span class="o">[][]</span> <span class="o">[]</span>  D   <span class="p">|</span><span class="o">=======</span><span class="p">|</span>____<span class="p">|</span>________________________<span class="p">|</span>_
</span></span><span class="line"><span class="cl">                 __/ <span class="o">=</span><span class="p">|</span> o <span class="p">|</span><span class="o">=</span>-~O<span class="o">=====</span><span class="nv">O</span><span class="o">=====</span><span class="nv">O</span><span class="o">=====</span>O<span class="se">\ </span>____Y___________<span class="p">|</span>__<span class="p">|</span>__________________________<span class="p">|</span>_
</span></span><span class="line"><span class="cl">                  <span class="p">|</span>/-<span class="o">=</span><span class="p">|</span>___<span class="p">|</span><span class="o">=</span>    <span class="o">||</span>    <span class="o">||</span>    <span class="o">||</span>    <span class="p">|</span>_____/~<span class="se">\_</span>__/          <span class="p">|</span>_D__D__D_<span class="p">|</span>  <span class="p">|</span>_D__D__D_<span class="p">|</span>
</span></span><span class="line"><span class="cl">                   <span class="se">\_</span>/      <span class="se">\_</span>_/  <span class="se">\_</span>_/  <span class="se">\_</span>_/  <span class="se">\_</span>_/      <span class="se">\_</span>/               <span class="se">\_</span>/   <span class="se">\_</span>/    <span class="se">\_</span>/   <span class="se">\_</span>/
</span></span></code></pre></div><h2 id="前言">前言</h2>
<p>容器的实现依赖于 Namespace 与 Cgroup ，它们是内核直接提供的功能，如果想要深入理解容器的运行机制，这是必须了解的知识点。</p>
<h2 id="namespace">Namespace</h2>
<p>命名空间 Namespace 是内核用来隔离资源的一项技术，不同的进程所拥有的资源可以互相隔离，互不干扰。</p>
<p>容器本质上也是系统的进程，但是它拥有独立的命名空间，可以和系统原有的进程隔离。</p>
<p>在 Linux 中已经定义的命名空间有 8 种：</p>
<ul>
<li>User ： 用户和用户组</li>
<li>PID ： 进程 ID</li>
<li>Mount ： 挂载点</li>
<li>Network ： 网络设备和网络协议栈</li>
<li>UTS ： 主机名和域名</li>
<li>IPC ： 进程间通信</li>
<li>Time ： 系统时钟</li>
<li>Cgroup ： cgroup 控制群组</li>
</ul>
<p>在这些不同的命名空间种类中， <code>Time</code> 和 <code>Cgroup</code> 在高版本的内核中才得到实现，现有生产环境的流行内核版本大部分只实现了前六种类型。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># CentOS 7.9</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Kernel Version 3.10.0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 以 root 用户运行</span>
</span></span><span class="line"><span class="cl">$ whoami
</span></span><span class="line"><span class="cl">root
</span></span><span class="line"><span class="cl">$ lsns
</span></span><span class="line"><span class="cl">        NS TYPE  NPROCS   PID USER   COMMAND
</span></span><span class="line"><span class="cl"><span class="m">4026531836</span> pid      <span class="m">115</span>     <span class="m">1</span> root   /usr/lib/systemd/systemd --switched-root --system --deserialize <span class="m">22</span>
</span></span><span class="line"><span class="cl"><span class="m">4026531837</span> user     <span class="m">115</span>     <span class="m">1</span> root   /usr/lib/systemd/systemd --switched-root --system --deserialize <span class="m">22</span>
</span></span><span class="line"><span class="cl"><span class="m">4026531838</span> uts      <span class="m">115</span>     <span class="m">1</span> root   /usr/lib/systemd/systemd --switched-root --system --deserialize <span class="m">22</span>
</span></span><span class="line"><span class="cl"><span class="m">4026531839</span> ipc      <span class="m">115</span>     <span class="m">1</span> root   /usr/lib/systemd/systemd --switched-root --system --deserialize <span class="m">22</span>
</span></span><span class="line"><span class="cl"><span class="m">4026531840</span> mnt      <span class="m">111</span>     <span class="m">1</span> root   /usr/lib/systemd/systemd --switched-root --system --deserialize <span class="m">22</span>
</span></span><span class="line"><span class="cl"><span class="m">4026531856</span> mnt        <span class="m">1</span>    <span class="m">18</span> root   kdevtmpfs
</span></span><span class="line"><span class="cl"><span class="m">4026531956</span> net      <span class="m">115</span>     <span class="m">1</span> root   /usr/lib/systemd/systemd --switched-root --system --deserialize <span class="m">22</span>
</span></span><span class="line"><span class="cl"><span class="m">4026532430</span> mnt        <span class="m">2</span>  <span class="m">1010</span> root   /usr/sbin/NetworkManager --no-daemon
</span></span><span class="line"><span class="cl"><span class="m">4026532439</span> mnt        <span class="m">1</span>  <span class="m">1027</span> chrony /usr/sbin/chronyd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 以低权级用户查看命名空间</span>
</span></span><span class="line"><span class="cl">$ whoami
</span></span><span class="line"><span class="cl">mine
</span></span><span class="line"><span class="cl">$ lsns
</span></span><span class="line"><span class="cl">        NS TYPE  NPROCS   PID USER COMMAND
</span></span><span class="line"><span class="cl"><span class="m">4026531836</span> pid        <span class="m">2</span>  <span class="m">8945</span> mine bash
</span></span><span class="line"><span class="cl"><span class="m">4026531837</span> user       <span class="m">2</span>  <span class="m">8945</span> mine bash
</span></span><span class="line"><span class="cl"><span class="m">4026531838</span> uts        <span class="m">2</span>  <span class="m">8945</span> mine bash
</span></span><span class="line"><span class="cl"><span class="m">4026531839</span> ipc        <span class="m">2</span>  <span class="m">8945</span> mine bash
</span></span><span class="line"><span class="cl"><span class="m">4026531840</span> mnt        <span class="m">2</span>  <span class="m">8945</span> mine bash
</span></span><span class="line"><span class="cl"><span class="m">4026531956</span> net        <span class="m">2</span>  <span class="m">8945</span> mine bash
</span></span><span class="line"><span class="cl"><span class="c1"># 仔细对比使用 root 和使用低权级用户的命名空间，可以发现它们仍然在同一 namespace 中，但是低权级用户仅能查询到有限的信息</span>
</span></span></code></pre></div><p>系统启动后默认会生成 init namespace ，系统进程基本都运行在 init namespace 中，后续的命名空间都和它是有关联的，大部分情况下是继承关系，某些特殊进程可能使用了一到两种额外的命名空间类型。</p>
<p>Linux 提供了用户层命令 <code>unshare</code> 和 <code>nsenter</code> 来操作进程的命名空间归属。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># CentOS 7.9</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Kernel Version 3.10.0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 当前系统可能对 user 命名空间有限制，一般有两种情况：</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 如果内核禁用了 user 命名空间，可能需要重新安装系统或者编译内核</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 如果编译选项正常，则可能是内核对命名空间数量做了限制</span>
</span></span><span class="line"><span class="cl">$ whoami
</span></span><span class="line"><span class="cl">root
</span></span><span class="line"><span class="cl">$ cat /boot/config-3.10.0-1160.el7.x86_64 <span class="p">|</span> grep -i user_ns
</span></span><span class="line"><span class="cl"><span class="nv">CONFIG_USER_NS</span><span class="o">=</span>y
</span></span><span class="line"><span class="cl">$ cat /proc/sys/user/max_user_namespaces 
</span></span><span class="line"><span class="cl"><span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 开放内核对命名空间的限制， unshare 才能正常创建 user 命名空间</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="m">10</span> &gt; /proc/sys/user/max_user_namespaces
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 模拟容器，创建一个隔离的进程</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># unshare --pid --user -r --uts --net --mount --ipc  --fork --mount-proc --propagation private /bin/sh</span>
</span></span><span class="line"><span class="cl">$ unshare <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>&gt; --mount --propagation private <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>&gt; --uts <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>&gt; --ipc <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>&gt; --net <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>&gt; --pid --fork --mount-proc <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>&gt; --user --map-root-user <span class="se">\
</span></span></span></code></pre></div><p>uts 和 ipc 基本上都是直接从原命名空间克隆一些必要的数据，后续和父空间互不干扰，比如 uts namespace 会克隆父空间的 <code>/proc/sys/kernel/hostname</code> 作为自己的 hostname 。</p>
<p>net 除了和父空间隔离外，会生成新的网络栈并默认生成独立的 lo 网络设备。</p>
<p>对于 user ， unshare 提供了 <code>-r/--map-root-user</code> 来实现 root 用户映射，低权级用户可以通过使用这个选项成为新命名空间中的 root 用户，获取最高权限。</p>
<p>对于 pid ，unshare 提供了 <code>--fork</code> 和 <code>--mount-proc</code> 扩展选项，值得注意的是这里无论带什么选项， unshare 这个进程不会加入新的 pid 命名空间：</p>
<ul>
<li><code>--mount-proc</code> 可以使得隔离进程和父空间的所有进程信息隔离开来，子空间的 pid 将重新从 1 开始衍生，但父空间仍然可以监控到这部分信息。如果不带 <code>--mount-proc</code> 选项，则父空间的 pid 信息会被子空间继承。</li>
<li><code>--fork</code> 则可以生成子进程来运行指定程序，如果使用上面的例子，你将会得到 <code>unshare</code> 进程和作为子进程的 <code>/bin/sh</code> ，其中 <code>unshare</code> 进程属于父 pid 命名空间，子进程 <code>/bin/sh</code> 新生成的子 pid 命名空间。如果不带 <code>--fork</code> 将无法生成新的 pid 命名空间，生成的 <code>/bin/sh</code> 仍然在原有的命名空间，并且它的生命周期极短，命令运行完成后进程就不再分配内存了。</li>
</ul>
<p>mount 命名空间是最复杂的一种，它使用 shared subtrees 运行机制，允许在不同 mount 命名空间之间自动，受控地传播 mount 事件和 unmount 事件。简单来说，我们通过设置某个命名空间的 propagation 属性，决定这个命名空间中挂载动作和卸载动作是如何传播到其他命名空间。</p>
<p>propagation 有 <code>private|shared|slave|unchanged</code> 这几种，最常用的是 private ，它默认从父空间继承挂载节点，后续不同空间的挂载动作和卸载动作互不影响，在 docker 的官方文档中，有这么一段话： <code>Volumes use rprivate bind propagation, and bind propagation is not configurable for volumes.</code> ，说明了卷是基于 mount 命名空间来实现挂载特性的。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 在运行容器的情况下查看现有的命名空间</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 使用 containerd 作为容器运行时</span>
</span></span><span class="line"><span class="cl">$ ctr i pull docker.io/library/busybox:latest
</span></span><span class="line"><span class="cl">$ ctr c create docker.io/library/busybox:latest busybox
</span></span><span class="line"><span class="cl">$ ctr t start -d busybox
</span></span><span class="line"><span class="cl">$ ctr t ls
</span></span><span class="line"><span class="cl">TASK         PID      STATUS    
</span></span><span class="line"><span class="cl">busybox    <span class="m">61830</span>    RUNNING
</span></span><span class="line"><span class="cl">$ lsns
</span></span><span class="line"><span class="cl">        NS TYPE  NPROCS   PID USER   COMMAND
</span></span><span class="line"><span class="cl"><span class="m">4026531836</span> pid      <span class="m">114</span>     <span class="m">1</span> root   /usr/lib/systemd/systemd --switched-root --system --deserialize <span class="m">22</span>
</span></span><span class="line"><span class="cl"><span class="m">4026531837</span> user     <span class="m">115</span>     <span class="m">1</span> root   /usr/lib/systemd/systemd --switched-root --system --deserialize <span class="m">22</span>
</span></span><span class="line"><span class="cl"><span class="m">4026531838</span> uts      <span class="m">114</span>     <span class="m">1</span> root   /usr/lib/systemd/systemd --switched-root --system --deserialize <span class="m">22</span>
</span></span><span class="line"><span class="cl"><span class="m">4026531839</span> ipc      <span class="m">114</span>     <span class="m">1</span> root   /usr/lib/systemd/systemd --switched-root --system --deserialize <span class="m">22</span>
</span></span><span class="line"><span class="cl"><span class="m">4026531840</span> mnt      <span class="m">112</span>     <span class="m">1</span> root   /usr/lib/systemd/systemd --switched-root --system --deserialize <span class="m">22</span>
</span></span><span class="line"><span class="cl"><span class="m">4026531856</span> mnt        <span class="m">1</span>    <span class="m">18</span> root   kdevtmpfs
</span></span><span class="line"><span class="cl"><span class="m">4026531956</span> net      <span class="m">114</span>     <span class="m">1</span> root   /usr/lib/systemd/systemd --switched-root --system --deserialize <span class="m">22</span>
</span></span><span class="line"><span class="cl"><span class="m">4026532430</span> mnt        <span class="m">1</span>   <span class="m">972</span> chrony /usr/sbin/chronyd
</span></span><span class="line"><span class="cl"><span class="m">4026532446</span> mnt        <span class="m">1</span> <span class="m">61830</span> root   sh
</span></span><span class="line"><span class="cl"><span class="m">4026532447</span> uts        <span class="m">1</span> <span class="m">61830</span> root   sh
</span></span><span class="line"><span class="cl"><span class="m">4026532448</span> ipc        <span class="m">1</span> <span class="m">61830</span> root   sh
</span></span><span class="line"><span class="cl"><span class="m">4026532449</span> pid        <span class="m">1</span> <span class="m">61830</span> root   sh
</span></span><span class="line"><span class="cl"><span class="m">4026532451</span> net        <span class="m">1</span> <span class="m">61830</span> root   sh
</span></span></code></pre></div><p>从实际运行的容器来看，基本可以验证容器是拥有独立命名空间的进程这一说法。</p>
<h2 id="cgroup">Cgroup</h2>
<p>cgroup 是内核用来控制系统资源的一项技术，它可以基于 cgroup 进行资源分配管控，主要针对硬件层面的资源，只需要将进程纳入 cgroup 就可以管控进程的资源。</p>
<p>根据前面所述，容器本质上也是系统的进程，那么它也可以交由 cgroup 进行资源控制。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ls /sys/fs/cgroup/
</span></span><span class="line"><span class="cl">total <span class="m">0</span>
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">5</span> root root  <span class="m">0</span> Apr <span class="m">14</span> 22:13 blkio
</span></span><span class="line"><span class="cl">lrwxrwxrwx. <span class="m">1</span> root root <span class="m">11</span> Apr <span class="m">14</span> 22:13 cpu -&gt; cpu,cpuacct
</span></span><span class="line"><span class="cl">lrwxrwxrwx. <span class="m">1</span> root root <span class="m">11</span> Apr <span class="m">14</span> 22:13 cpuacct -&gt; cpu,cpuacct
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">5</span> root root  <span class="m">0</span> Apr <span class="m">14</span> 22:13 cpu,cpuacct
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">3</span> root root  <span class="m">0</span> Apr <span class="m">14</span> 22:13 cpuset
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">5</span> root root  <span class="m">0</span> Apr <span class="m">27</span> 21:01 devices
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">3</span> root root  <span class="m">0</span> Apr <span class="m">14</span> 22:13 freezer
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">3</span> root root  <span class="m">0</span> Apr <span class="m">14</span> 22:13 hugetlb
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">5</span> root root  <span class="m">0</span> Apr <span class="m">14</span> 22:13 memory
</span></span><span class="line"><span class="cl">lrwxrwxrwx. <span class="m">1</span> root root <span class="m">16</span> Apr <span class="m">14</span> 22:13 net_cls -&gt; net_cls,net_prio
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">3</span> root root  <span class="m">0</span> Apr <span class="m">14</span> 22:13 net_cls,net_prio
</span></span><span class="line"><span class="cl">lrwxrwxrwx. <span class="m">1</span> root root <span class="m">16</span> Apr <span class="m">14</span> 22:13 net_prio -&gt; net_cls,net_prio
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">3</span> root root  <span class="m">0</span> Apr <span class="m">14</span> 22:13 perf_event
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">5</span> root root  <span class="m">0</span> Apr <span class="m">14</span> 22:13 pids
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">5</span> root root  <span class="m">0</span> Apr <span class="m">14</span> 22:13 systemd
</span></span></code></pre></div><p>cgroup filesystem 是使用 cgroup 时内核态与用户态沟通的重要节点，默认路径一般为 <code>/sys/fs/cgroup</code> ，目前 cgroup 有 v1 和 v2 两个版本，这里使用的是 cgroup v1 ，如果想要使用 cgroup v2 ，应该通过 <code>/proc/filesystems</code> 查看当前内核是否支持。</p>
<p>在这里我们可以看到 cgroupfs 将各种资源划分到多个子系统，主要有 cpu ， memory ， net ， blk 这几种资源，它们对应的控制器名称在后续创建 cgroup 是比较重要的。</p>
<h3 id="使用-libcgroup-创建-cgroup">使用 libcgroup 创建 cgroup</h3>
<p>使用 libcgroup 创建 cgroup 并不是特别推荐的做法，但是可以帮助我们深入了解如何定义和控制 cgroup 。</p>
<p>如前文所述，我们需要通过 cgroup filesystem 来和内核沟通，虽然可以在 <code>/sys/fs/cgroup</code> 中直接创建新的 cgroup ，但是我们选择重新挂载 cgroupfs 来学习具体的工作过程。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 挂载 cgroup fs</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 以挂载两种子系统为例</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 首先创建目录，实际中可以自由命名</span>
</span></span><span class="line"><span class="cl">$ mkdir -p /mnt/cgroups/cpuset
</span></span><span class="line"><span class="cl">$ mkdir -p /mnt/cgroups/memory
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 挂载 cpuset 和 memory 子系统</span>
</span></span><span class="line"><span class="cl">$ mount -t cgroup -o cpuset cgroup_cpuset /mnt/cgroups/cpuset
</span></span><span class="line"><span class="cl">$ mount -t cgroup -o memory cgroup_memory /mnt/cgroups/memory
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 可以查询到新挂载的 cgroup fs ，对应目录下也会自动创建相应的控制器</span>
</span></span><span class="line"><span class="cl">$ mount -l
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">cgroup_memory on /mnt/cgroups/memory <span class="nb">type</span> cgroup <span class="o">(</span>rw,relatime,seclabel,memory<span class="o">)</span>
</span></span><span class="line"><span class="cl">cgroup_cpuset on /mnt/cgroups/cpuset <span class="nb">type</span> cgroup <span class="o">(</span>rw,relatime,seclabel,cpuset<span class="o">)</span>
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 卸载子系统</span>
</span></span><span class="line"><span class="cl">$ umount /mnt/cgroups/memory
</span></span><span class="line"><span class="cl">$ umount /mnt/cgroups/cpuset
</span></span></code></pre></div><p>自行挂载的 cgroup fs 在机器重启后会自动失效，如果确实需要使用 libcgroup ，推荐做法是将需要挂载的子系统和 cgroup 一并写入 <code>/etc/cgconfig.conf</code> 并启动 cgconfig 服务，就可以使自定义 cgroup 保持重启系统生效。</p>
<p>在挂载子系统完成后，就可以在对应的子系统中需要创建需要的 cgroup 。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 创建 cgroup</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 注意需要切换到新挂载的子系统目录下，否则 cgroup 会默认创建到 /sys/fs/cgroup 下的子系统</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> /mnt/cgroups/memory
</span></span><span class="line"><span class="cl"><span class="c1"># cgcreate 的创建语法为 -g &lt;controller_name&gt;:&lt;custom_name&gt; ，控制器和子系统对应，cgroup 命名则无限制</span>
</span></span><span class="line"><span class="cl">$ cgcreate -g memory:mem
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 在对应目录下直接 mkdir 也可以创建 cgroup ，下面的语句等效于 cgcreate -g memory:mem</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> /mnt/cgroups/memory
</span></span><span class="line"><span class="cl">$ mkdir mem
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 一些其它控制器的例子</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> /mnt/cgroups/cpuset
</span></span><span class="line"><span class="cl">$ cgcreate -g cpuset:custom_cpuset
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看创建的 cgroup</span>
</span></span><span class="line"><span class="cl">$ ll /mnt/cgroups/memory
</span></span><span class="line"><span class="cl">total <span class="m">0</span>
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 cgroup.clone_children
</span></span><span class="line"><span class="cl">--w--w--w-. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 cgroup.event_control
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 cgroup.procs
</span></span><span class="line"><span class="cl">-r--r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 cgroup.sane_behavior
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">0</span> May <span class="m">13</span> 22:06 mem  <span class="c1"># 新增的 cgroup</span>
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 memory.failcnt
</span></span><span class="line"><span class="cl">--w-------. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 memory.force_empty
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 memory.kmem.failcnt
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 memory.kmem.limit_in_bytes
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 memory.kmem.max_usage_in_bytes
</span></span><span class="line"><span class="cl">-r--r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 memory.kmem.slabinfo
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 memory.kmem.tcp.failcnt
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 memory.kmem.tcp.limit_in_bytes
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 memory.kmem.tcp.max_usage_in_bytes
</span></span><span class="line"><span class="cl">-r--r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 memory.kmem.tcp.usage_in_bytes
</span></span><span class="line"><span class="cl">-r--r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 memory.kmem.usage_in_bytes
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 memory.limit_in_bytes
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 memory.max_usage_in_bytes
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 memory.memsw.failcnt
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 memory.memsw.limit_in_bytes
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 memory.memsw.max_usage_in_bytes
</span></span><span class="line"><span class="cl">-r--r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 memory.memsw.usage_in_bytes
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 memory.move_charge_at_immigrate
</span></span><span class="line"><span class="cl">-r--r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 memory.numa_stat
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 memory.oom_control
</span></span><span class="line"><span class="cl">----------. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 memory.pressure_level
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 memory.soft_limit_in_bytes
</span></span><span class="line"><span class="cl">-r--r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 memory.stat
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 memory.swappiness
</span></span><span class="line"><span class="cl">-r--r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 memory.usage_in_bytes
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 memory.use_hierarchy
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 notify_on_release
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 21:36 release_agent
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> May <span class="m">13</span> 22:00 tasks
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 删除 cgroup ，它的全部进程会移动到其父群组</span>
</span></span><span class="line"><span class="cl">$ cgdelete -g memory:mem
</span></span></code></pre></div><p>创建完 cgroup 后，我们就可以调整资源参数，并将进程加入到 cgroup 中使它们受到对应的资源约束。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 设置 cgroup 参数同样需要注意路径的问题</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> /mnt/cgroups/memory
</span></span><span class="line"><span class="cl">$ cgset -r memory.limit_in_bytes<span class="o">=</span>2M mem
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 将进程运行于 cgroup 中</span>
</span></span><span class="line"><span class="cl">$ cgexec -g memory:mem top
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 将已有进程加入到 cgroup 中</span>
</span></span><span class="line"><span class="cl">$ cgclassify -g memory:mem &lt;pid&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看对应 cgroup 中运行的进程</span>
</span></span><span class="line"><span class="cl">$ cat /mnt/cgroups/memory/mem/tasks
</span></span></code></pre></div><h3 id="使用-systemd-创建-cgroup">使用 systemd 创建 cgroup</h3>
<p>使用 systemd 来生成 cgroup 是更合适的做法。</p>
<p>systemd 提供了 slice ， service 和 scope 几个资源等级，其中 slice 是最上层的等级，默认情况下，系统会创建四种 slice ：</p>
<ul>
<li>-.slice ： 根 slice 。</li>
<li>system.slice ： 所有系统 service 的默认位置。</li>
<li>user.slice ： 所有用户会话的默认位置。</li>
<li>machine.slice ： 所有虚拟机和 Linux 容器的默认位置。</li>
</ul>
<p>我们可以通过 <code>systemd-cgls</code> 来查看 systemd 生成的 cgroup ，可以看到最小单位是 service 和 scope 。其中 service 是用户最常接触的 systemd 资源，一般通过 <code>.service</code> 文件定义具体的运行细节，然后交由 systemd 管控，而 scope 更多地用于用户进程，一般用户的交互式 shell 进程都由 scope 管理，并处于 user.slice 分片这个层级之中。</p>
<p>我们需要关注 <code>/sys/fs/cgroup/systemd</code> 这个目录，进入这个目录就可以看到标准的 cgroup 控制文件和下属的 slice ，再深入 slice 则是各自下属的 service 和 scope ， <code>/sys/fs/cgroup/systemd</code> 实际上就是一个 cgroup ，而 slice ， service 和 scope 就是 systemd 的子 cgroup 。但是由 systemd 管控的 cgroup 比较特殊，不会直接暴露它所拥有的控制器。</p>
<p>使用 systemd 生成 cgroup 我们无需关心 cgroupfs ，直接使用 systemd 提供的命令操作即可，并且后续都不应该直接操作这些 cgroup 。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 使用 systemd-run 创建临时 cgroup</span>
</span></span><span class="line"><span class="cl">$ systemd-run --unit<span class="o">=</span>toptest --slice<span class="o">=</span><span class="nb">test</span> top -b
</span></span><span class="line"><span class="cl"><span class="c1"># 可以通过带 --scope 则生成 scope 等级的 systemd 资源，不带则默认是 service 等级</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 不指定 slice 则默认是 system.slice</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 生成的 unit 直接受 systemctl 管制</span>
</span></span><span class="line"><span class="cl">$ systemctl status toptest
</span></span><span class="line"><span class="cl">● toptest.service - /usr/bin/top -b
</span></span><span class="line"><span class="cl">   Loaded: loaded <span class="o">(</span>/run/systemd/system/toptest.service<span class="p">;</span> static<span class="p">;</span> vendor preset: disabled<span class="o">)</span>
</span></span><span class="line"><span class="cl">  Drop-In: /run/systemd/system/toptest.service.d
</span></span><span class="line"><span class="cl">           └─50-Description.conf, 50-ExecStart.conf, 50-Slice.conf
</span></span><span class="line"><span class="cl">   Active: active <span class="o">(</span>running<span class="o">)</span> since Sat 2022-05-14 01:17:06 CST<span class="p">;</span> 6min ago
</span></span><span class="line"><span class="cl"> Main PID: <span class="m">3708</span> <span class="o">(</span>top<span class="o">)</span>
</span></span><span class="line"><span class="cl">   CGroup: /test.slice/toptest.service
</span></span><span class="line"><span class="cl">           └─3708 /usr/bin/top -b
</span></span><span class="line"><span class="cl"><span class="c1"># 临时 systemd unit 在运行完成后会自动消亡</span>
</span></span></code></pre></div><p>而如果是需要长期使用的 cgroup ，应该定义为 service 资源，并将需要的配置参数写入到 <code>.service</code> 文件，存放路径应为 <code>/usr/lib/systemd/system/</code> ，服务类型的软件一般都会自动将它们的服务定义文件安装到这个目录，这样就可以和 <code>systemd-run</code> 生成的 unit 一样，直接使用 <code>systemctl</code> 来操作。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 设置 systemd unit 的参数</span>
</span></span><span class="line"><span class="cl"><span class="c1"># systemd 对 cgroup 参数做了封装，具体使用需要参考具体文档</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 设置 service 的参数</span>
</span></span><span class="line"><span class="cl">$ systemctl set-property sshd <span class="nv">MemoryLimit</span><span class="o">=</span>50M --runtime
</span></span><span class="line"><span class="cl"><span class="c1"># --runtime 允许临时改变现有的参数，重启系统或者删除运行时配置后参数会恢复原有设置</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 设置的参数会写入到 /run/systemd/system/sshd.service.d/ 下的配置文件中</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 不带 --runtime 会写入到独立的配置文件中，重启系统后也能生效</span>
</span></span><span class="line"><span class="cl">$ systemctl set-property sshd <span class="nv">MemoryLimit</span><span class="o">=</span>50M
</span></span><span class="line"><span class="cl">$ cat /etc/systemd/system/sshd.service.d/50-MemoryLimit.conf 
</span></span><span class="line"><span class="cl"><span class="o">[</span>Service<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">MemoryLimit</span><span class="o">=</span><span class="m">52428800</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 还可以通过手动修改 service 文件实现，和不带 runtime 效果一致</span>
</span></span><span class="line"><span class="cl">$ cat /etc/systemd/system/sshd.service.d/50-MemoryLimit.conf &gt;&gt; /usr/lib/systemd/system/sshd.service
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 新增参数和删除参数需要修改或者移除相关配置文件，然后重载服务</span>
</span></span><span class="line"><span class="cl">$ systemctl daemon-reload
</span></span><span class="line"><span class="cl">$ systemctl restart sshd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 如果是由 systemd-run 启动的资源，使用 --runtime 的意义不大，重启后都会失效，但依然可以实时改变参数</span>
</span></span><span class="line"><span class="cl">$ systemctl set-property toptest <span class="nv">MemoryLimit</span><span class="o">=</span>10M --runtime
</span></span><span class="line"><span class="cl">$ systemctl status toptest
</span></span><span class="line"><span class="cl">● toptest.service - /usr/bin/top -b
</span></span><span class="line"><span class="cl">   Loaded: loaded <span class="o">(</span>/run/systemd/system/toptest.service<span class="p">;</span> static<span class="p">;</span> vendor preset: disabled<span class="o">)</span>
</span></span><span class="line"><span class="cl">  Drop-In: /run/systemd/system/toptest.service.d
</span></span><span class="line"><span class="cl">           └─50-Description.conf, 50-ExecStart.conf, 50-MemoryLimit.conf, 50-Slice.conf
</span></span><span class="line"><span class="cl">   Active: active <span class="o">(</span>running<span class="o">)</span> since Sat 2022-05-14 17:19:07 CST<span class="p">;</span> 17s ago
</span></span><span class="line"><span class="cl"> Main PID: <span class="m">2661</span> <span class="o">(</span>top<span class="o">)</span>
</span></span><span class="line"><span class="cl">   Memory: 0B <span class="o">(</span>limit: 10.0M<span class="o">)</span>
</span></span><span class="line"><span class="cl">   CGroup: /test.slice/toptest.service
</span></span><span class="line"><span class="cl">           └─2661 /usr/bin/top -b
</span></span></code></pre></div><p>现有常用的容器进行时中， docker 默认会在 <code>/sys/fs/cgroup</code> 的各个子系统中自行维护 cgroup ，但可以通过修改 cgroup driver 来托管到 systemd 中，而 containerd 也存在类似的驱动设置。</p>
<p>在 docker 使用 <code>&quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]</code> 改变 cgroup driver 的情况下，新运行的容器会作为 system.slice 中的 scope 运行，如果使用默认的 cgroupfs 的情况下，会如前面所述，在 <code>/sys/fs/cgroup</code> 的各个子系统中创建 cgroup ，而不是托管在 systemd 中。</p>
<h2 id="结语">结语</h2>
<p>总结来看，容器依赖内核功能来实现隔离能力， namespace 主要面向信息隔离， cgroup 主要面向资源隔离管控，在实际使用中，我们无需细致去关心它们的技术细节，但是了解它们的实现原理对后续学习是比较有帮助的。</p></article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
<script type="application/javascript" src='https://yuweizzz.github.io/js/toc.js'></script>
<link rel="stylesheet" href='https://yuweizzz.github.io/css/toc.css' />



  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://yuweizzz.github.io/">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>
</body>

<script type="application/javascript" src="https://yuweizzz.github.io/js/github-style.js"></script>


<script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
<script type="text/javascript" src="https://yuweizzz.github.io/js/CustomLive2D.js"></script>


</html>
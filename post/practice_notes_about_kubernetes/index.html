<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://yuweizzz.github.io/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/github.min.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/github-style.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/light.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/dark.css' />
    <link rel="stylesheet" href='https://yuweizzz.github.io/css/syntax.css' />
    <title>Kubernetes 实践笔记 - Wei&#39;s blog</title>
    
    <link rel="icon" type="image/x-icon" href='/images/github.png'>
    
    <meta name="theme-color" content="#1e2327">

    
    <meta name="description"
  content="这篇笔记用来记录一些 Kubernetes 的相关知识。
" />
<meta name="keywords"
  content='blog, google analytics' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://yuweizzz.github.io/post/practice_notes_about_kubernetes/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Kubernetes 实践笔记 - Wei&#39;s blog" />
<meta name="twitter:description"
  content="这篇笔记用来记录一些 Kubernetes 的相关知识。
" />
<meta name="twitter:site" content="https://yuweizzz.github.io" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://yuweizzz.github.io">


<meta property="og:type" content="article" />
<meta property="og:title" content="Kubernetes 实践笔记 - Wei&#39;s blog">
<meta property="og:description"
  content="这篇笔记用来记录一些 Kubernetes 的相关知识。
" />
<meta property="og:url" content="https://yuweizzz.github.io/post/practice_notes_about_kubernetes/" />
<meta property="og:site_name" content="Kubernetes 实践笔记" />
<meta property="og:image"
  content="https://yuweizzz.github.io">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2022-09-10 15:22:45 &#43;0000 UTC" />











<script async src="https://www.googletagmanager.com/gtag/js?id=UA-174929827-1"></script>
<script>
  if (navigator.doNotTrack !== '1') {
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-174929827-1');
  }
</script>


</head>

<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://yuweizzz.github.io">
        <svg class="octicon" height="32" viewBox="0 0 16 16" version="1.1" width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd"
            d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          <form target="_blank" action="https://www.google.com/search" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
              <input type="hidden" name="q" value="site:https://yuweizzz.github.io">
            </label>
          </form>
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://yuweizzz.github.io">
        <svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" version="1.1"
          width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>
  
<div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://yuweizzz.github.io">
                  <img class=" avatar-user"
                    src="https://yuweizzz.github.io/images/avatar.png"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://yuweizzz.github.io">Wei</a></span><span
                    class="path-divider">/</span><strong class="css-truncate-target mr-1" style="max-width: 410px"><a
                      href="https://yuweizzz.github.io/post/practice_notes_about_kubernetes/">Kubernetes 实践笔记</a></strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Sat, 10 Sep 2022 15:22:45 &#43;0000"
                    class="no-wrap">
                    Sat, 10 Sep 2022 15:22:45 &#43;0000</relative-time>

                  
                  <span class="file-info-divider"></span>
                  Modified <relative-time datetime="Sun, 06 Aug 2023 14:52:25 &#43;0000"
                    class="no-wrap">
                    Sun, 06 Aug 2023 14:52:25 &#43;0000</relative-time>
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div id="post-header" class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style="z-index: 2">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    
                    <summary id="toc-toggle" onclick="clickToc()" class="btn btn-octicon m-0 mr-2 p-2">
                      <svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered">
                        <path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zM3 8a1 1 0 11-2 0 1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"></path>
                      </svg>
                    </summary>
                    <details-menu class="SelectMenu" id="toc-details" style="display: none;">
                      <div class="SelectMenu-modal rounded-3 mt-1" style="max-height: 340px;">
                        <div class="SelectMenu-list SelectMenu-list--borderless p-2" style="overscroll-behavior: contain;" id="toc-list">
                        </div>
                      </div>
                    </details-menu>
                      3082 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                    
                    <a class="muted-link mr-3" href="/tags/kubernetes">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      kubernetes
                    </a>
                    
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5" style="z-index: 1">
                <article class="markdown-body entry-content container-lg"><p>这篇笔记用来记录一些 Kubernetes 的相关知识。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">
                                       <span class="o">(</span>@@<span class="o">)</span> <span class="o">(</span>  <span class="o">)</span> <span class="o">(</span>@<span class="o">)</span>  <span class="o">(</span> <span class="o">)</span>  @@    <span class="o">()</span>    @     O     @     O      @
                                  <span class="o">(</span>   <span class="o">)</span>
                              <span class="o">(</span>@@@@<span class="o">)</span>
                           <span class="o">(</span>    <span class="o">)</span>

                         <span class="o">(</span>@@@<span class="o">)</span>
                       <span class="o">====</span>        ________                ___________
                   _D _<span class="p">|</span>  <span class="p">|</span>_______/        <span class="se">\_</span>_I_I_____<span class="o">===</span>__<span class="p">|</span>_________<span class="p">|</span>
                    <span class="p">|</span><span class="o">(</span>_<span class="o">)</span>---  <span class="p">|</span>   H<span class="se">\_</span>_______/ <span class="p">|</span>   <span class="p">|</span>        <span class="o">=</span><span class="p">|</span>___ ___<span class="p">|</span>      _________________
                    /     <span class="p">|</span>  <span class="p">|</span>   H  <span class="p">|</span>  <span class="p">|</span>     <span class="p">|</span>   <span class="p">|</span>         <span class="o">||</span>_<span class="p">|</span> <span class="p">|</span>_<span class="o">||</span>     _<span class="p">|</span>                <span class="se">\_</span>____A
                   <span class="p">|</span>      <span class="p">|</span>  <span class="p">|</span>   H  <span class="p">|</span>__--------------------<span class="p">|</span> <span class="o">[</span>___<span class="o">]</span> <span class="p">|</span>   <span class="o">=</span><span class="p">|</span>                        <span class="p">|</span>
                   <span class="p">|</span> ________<span class="p">|</span>___H__/__<span class="p">|</span>_____/<span class="o">[][]</span>~<span class="se">\_</span>______<span class="p">|</span>       <span class="p">|</span>   -<span class="p">|</span>                        <span class="p">|</span>
                   <span class="p">|</span>/ <span class="p">|</span>   <span class="p">|</span>-----------I_____I <span class="o">[][]</span> <span class="o">[]</span>  D   <span class="p">|</span><span class="o">=======</span><span class="p">|</span>____<span class="p">|</span>________________________<span class="p">|</span>_
                 __/ <span class="o">=</span><span class="p">|</span> o <span class="p">|</span><span class="o">=</span>-~O<span class="o">=====</span><span class="nv">O</span><span class="o">=====</span><span class="nv">O</span><span class="o">=====</span>O<span class="se">\ </span>____Y___________<span class="p">|</span>__<span class="p">|</span>__________________________<span class="p">|</span>_
                  <span class="p">|</span>/-<span class="o">=</span><span class="p">|</span>___<span class="p">|</span><span class="o">=</span>    <span class="o">||</span>    <span class="o">||</span>    <span class="o">||</span>    <span class="p">|</span>_____/~<span class="se">\_</span>__/          <span class="p">|</span>_D__D__D_<span class="p">|</span>  <span class="p">|</span>_D__D__D_<span class="p">|</span>
                   <span class="se">\_</span>/      <span class="se">\_</span>_/  <span class="se">\_</span>_/  <span class="se">\_</span>_/  <span class="se">\_</span>_/      <span class="se">\_</span>/               <span class="se">\_</span>/   <span class="se">\_</span>/    <span class="se">\_</span>/   <span class="se">\_</span>/

</code></pre></div><h2 id="安装-kubernetes">安装 kubernetes</h2>
<p>这里主要记录一些 kubernetes 初始化遇到的问题和解决方法。</p>
<p>首先是 <code>kubelet</code> ， <code>kubeadm</code> 和 <code>kubectl</code> 三个基本的软件，此外你还需要额外安装容器运行时，可以选择 <code>docker</code> ， <code>containerd</code> 或者 <code>crio</code> 等。</p>
<p>根据官方文档和实际运行情况来看，由于国内网络的问题，为了避免拉取镜像失败，最好把容器运行时配置中的 <code>pause</code> 镜像修改掉，以 <code>crio</code> 为例子：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ cat /etc/crio/crio.conf
......
<span class="o">[</span>crio.image<span class="o">]</span>
<span class="nv">pause_image</span> <span class="o">=</span> <span class="s2">&#34;registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6&#34;</span>
......

$ systemctl <span class="nb">enable</span> crio
$ systemctl reload crio
</code></pre></div><p>修改容器运行时配置并重启服务后，还需要启用内核模块和修改一些内核参数：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 修改内核参数</span>
$ <span class="nb">echo</span> <span class="m">1</span> &gt; /proc/sys/net/ipv4/ip_forward  <span class="c1"># 不开启 ip forward 初始化会报错</span>
<span class="c1"># 持久化内核参数</span>
$ <span class="nb">echo</span> net.ipv4.ip_forward <span class="o">=</span> <span class="m">1</span> &gt; /etc/sysctl.d/kubernetes.conf

<span class="c1"># 启用内核模块</span>
$ modprobe br_netfilter  <span class="c1"># 不启用 br_netfilter 初始化会报错</span>
</code></pre></div><p>然后就可以使用 <code>kubeadm</code> 来初始化控制平面：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 直接调用 init 命令来进行初始化</span>
$ kubeadm init <span class="se">\
</span><span class="se"></span>  --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers <span class="se">\
</span><span class="se"></span>  --pod-network-cidr 10.244.0.0/16 <span class="se">\
</span><span class="se"></span>  --service-cidr 10.96.0.0/16 <span class="se">\
</span><span class="se"></span>  --cri-socket unix:///var/run/crio/crio.sock <span class="se">\
</span><span class="se"></span>  --v <span class="m">5</span>

<span class="c1"># 生成默认配置文件并进行修改，然后根据配置文件进行初始化</span>
$ kubeadm config print init-defaults --component-configs KubeProxyConfiguration,KubeletConfiguration &gt; config.yaml
$ kubeadm init --config config.yaml
<span class="c1"># config.yaml 中需要修改的地方有：</span>
<span class="c1"># InitConfiguration.localAPIEndpoint.advertiseAddress 需要修改为主机 IP 地址</span>
<span class="c1"># InitConfiguration.nodeRegistration.name 按照需要修改为对应主机名</span>
<span class="c1"># InitConfiguration.nodeRegistration.criSocket 需要修改为正确的容器运行时监听地址，相当于 --cri-socket</span>
<span class="c1"># ClusterConfiguration.imageRepository 需要修改为国内的镜像地址，相当于 --image-repository</span>
<span class="c1"># ClusterConfiguration.networking.serviceSubnet 需要修改为 service 网络范围，相当于 --service-cidr</span>
<span class="c1"># ClusterConfiguration.networking.podSubnet 需要修改为 pod 网络范围，相当于 --pod-network-cidr</span>
<span class="c1"># KubeProxyConfiguration.mode 可以按照需要修改为 ipvs ，否则默认使用 iptables</span>
</code></pre></div><p>初始化完成后，可以使用 <code>kubectl</code> 来查看集群状态：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 复制证书信息到当前用户工作目录下</span>
$ cp /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
$ kubectl get node
$ kubectl get pods -A

<span class="c1"># 直接声明 KUBECONFIG 变量指定证书信息</span>
$ <span class="nb">export</span> <span class="nv">KUBECONFIG</span><span class="o">=</span>/etc/kubernetes/admin.conf
$ kubectl get node
$ kubectl get pods -A
</code></pre></div><p>这时节点仍处于 NotReady 状态，因为网络插件还没有安装，可以选择需要的网络插件进行安装，这里以 <code>flannel</code> 为例子：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ curl -L -O https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
<span class="c1"># 修改 kube-flannel.yml 中 ConfigMap 的 Network 为需要的 podSubnet</span>
$ kubectl apply -f kube-flannel.yml
</code></pre></div><p>安装完成后整个节点就会处于 Ready 状态，主节点安装完成。接下来如果要为这个集群添加工作节点，那么需要在工作节点上安装 <code>kubelet</code> ， <code>kubeadm</code> 和容器运行时，为了保证工作节点的正常运行，也应该开启对应的内核模块并修改内核参数，然后执行对应的命令即可：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 主节点生成 token</span>
$ kubeadm token create --print-join-command
<span class="c1"># 生成的 token 可以在 secret 中找到，对应的 type 为 bootstrap.kubernetes.io/token</span>
$ kubectl get secret -n kube-system

<span class="c1"># 工作节点通过主节点提供的 token 加入集群</span>
$ kubeadm join &lt;api-server-endpoint&gt; --token &lt;discovery-token&gt; --discovery-token-ca-cert-hash &lt;discovery-token-ca-cert-hash&gt;
</code></pre></div><h2 id="允许控制平面节点调度">允许控制平面节点调度</h2>
<p>kubernetes 的控制平面节点默认是不允许调度的，它在一些低版本中也称为 Master 节点或主节点，可以通过 <code>kubectl describe nodes &lt;name&gt;</code> 看到主节点信息中带有污点 <code>node-role.kubernetes.io/control-plane:NoSchedule</code> ，可以通过去掉这部信息来允许主节点进行 Pod 调度。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 假设主节点名称为 k8s-master</span>
<span class="c1"># 去除主节点禁止调度的污点</span>
$ kubectl taint node k8s-master node-role.kubernetes.io/control-plane-

<span class="c1"># 还原主节点禁止调度的污点</span>
$ kubectl taint node k8s-master node-role.kubernetes.io/control-plane<span class="o">=</span><span class="s2">&#34;&#34;</span>:NoSchedule
</code></pre></div><h2 id="修改-pod-的-host">修改 Pod 的 Host</h2>
<p>有时候需要把一些特殊域名指定为固定的 IP 地址，可以通过 <code>hostAliases</code> 来实现，它相当于向 <code>/etc/hosts</code> 中添加了对应的信息。</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hostaliases-pod</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Never</span><span class="w">
</span><span class="w">  </span><span class="nt">hostAliases</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">ip</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;127.0.0.1&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">hostnames</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;foo.local&#34;</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;bar.local&#34;</span><span class="w">
</span><span class="w">  </span>- <span class="nt">ip</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10.1.2.3&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">hostnames</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;foo.remote&#34;</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;bar.remote&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cat-hosts</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox:1.28</span><span class="w">
</span><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">cat</span><span class="w">
</span><span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;/etc/hosts&#34;</span><span class="w">
</span></code></pre></div><p>上述文件是官方文档给出的实例，如果是 <code>pod</code> 则应该将 <code>hostAliases</code> 添加到 <code>.spec.hostAliases</code> 这个字段中，而在 <code>deployment</code> 中则应该添加到 <code>.spec.template.spec.hostAliases</code> 这个字段中。</p>
<h2 id="br_netfilter-的重要作用">br_netfilter 的重要作用</h2>
<p>在 Pod 中通过 service 的名称来访问对应的服务时， <code>br_netfilter</code> 起到极为重要的作用，建议把这个模块写入到模块开机启动配置 <code>/etc/modules-load.d/modules.conf</code> 当中。</p>
<p>由于一开始没有启用这个模块，导致所有域名访问方式都超时失效，所以就选择使用 dnsutils 镜像进行 <code>dig</code> 排查，结果返回了奇怪的报错信息： <code>reply from unexpected source: 10.244.0.22#53, expected 10.96.0.10#53</code> ，在查看官方 issue 之后，直接在对应节点上执行 <code>modprobe br_netfilter</code> 马上就解决了问题。</p>
<p>其实这里也侧面反映出了 service 的服务原理， Pod 所配置的 <code>/etc/resolv.conf</code> 是 kube-dns service 的 IP 地址 <code>10.96.0.10</code> ，所以 DNS 请求直接向这个地址发起请求，数据包正常从 Pod 内经过 kube-proxy 后发往 kube-dns 的任一 Pod 中，但是在数据包返回时，由于没有启用 <code>br_netfilter</code> 模块， nat 没有正常修改返回地址，导致最终返回到 Pod 中时，远端 IP 地址是 kube-dns 其中某一个 Pod IP ，被 Pod 认为不是正确的返回包直接丢弃，产生超时报错。</p>
<h2 id="pod-的-dns-策略">Pod 的 DNS 策略</h2>
<p>根据官网，目前 Kubernetes 支持以下特定 Pod 的 DNS 策略，设定字段为 <code>.spec.dnsPolicy</code> ：</p>
<ul>
<li><code>Default</code> ： Pod 从运行所在的节点继承 <code>/etc/resolv.conf</code> ，但是这种策略并不是 Pod 默认的 DNS 策略。</li>
<li><code>ClusterFirst</code> ：使用集群提供的 DNS 服务，通常使用 CoreDNS 作为集群 DNS ， <code>ClusterFirst</code> 才是 Pod 默认的 DNS 策略。</li>
<li><code>ClusterFirstWithHostNet</code> ：对于以 hostNetwork 方式运行的 Pod ，应该将它的 DNS 策略显式设置为 <code>ClusterFirstWithHostNet</code> 。</li>
<li><code>None</code> ：允许 Pod 忽略集群中的 DNS 设置并使用 <code>.spec.dnsConfig</code> 作为 DNS 设置。</li>
</ul>
<p>使用 <code>Default</code> 策略时， Pod 中的 <code>/etc/resolv.conf</code> 将和宿主机中的 <code>/etc/resolv.conf</code> 完全一致，这时就无法通过 service name 域名的方式去访问内部服务。</p>
<p>使用 <code>ClusterFirst</code> 策略时，可以突破 <code>Default</code> 策略的限制，在 Pod 中直接通过 service name 域名去访问集群中 service 类型的资源，这时 Pod 中的 <code>/etc/resolv.conf</code> 一般会是如下的内容：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">search default.svc.cluster.local svc.cluster.local cluster.local
nameserver 10.96.0.10
options ndots:5
</code></pre></div><p>可以看到 <code>search</code> 把搜索域限定在集群中，所以我们就可以直接访问内部服务了，不跨命名空间的 service 访问将在 <code>default.svc.cluster.local</code> 域中搜索，因为这部分内容取自 <code>default</code> 命名空间中的 Pod ，不同命名空间中的 Pod 将会自动跟随当前所在空间；跨命名空间的 service 访问将在 <code>svc.cluster.local</code> 域中搜索，但没有显式给出命名空间，所以要由使用者自动指定 service name 加 namespace name 的域名。</p>
<p>而 <code>options</code> 中的 <code>ndots</code> 是用来判断是否需要使用 <code>search</code> 查找域的凭据，如果给定域名中的 <code>.</code> 小于 <code>ndots</code> 定义的数值，则会先在所有 <code>search</code> 定义的域中查询，在这些查询都失败后再直接使用给定域名进行查询。当访问内部服务时，不论是否跨命名空间，给定域名是 <code>service-name</code> 或 <code>service-name.namespace-name</code> 这种形式，它们都会被 <code>ndots</code> 命中并执行 <code>search</code> 查找。</p>
<p>使用 <code>ClusterFirstWithHostNet</code> 策略则是在 <code>.spec.hostNetwork</code> 值为 <code>true</code> 时所需要使用的关键字，不使用这个策略，则 <code>.spec.hostNetwork</code> 值为 <code>true</code> 的 Pod 无法访问集群内部服务。</p>
<p>使用 <code>None</code> 策略可以参考官方给出的配置参考，定义自己需要的配置：</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dns-example</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test</span><span class="w">
</span><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">dnsPolicy</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;None&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">dnsConfig</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">nameservers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="m">192.0.2.1</span><span class="w">
</span><span class="w">    </span><span class="nt">searches</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">ns1.svc.cluster-domain.example</span><span class="w">
</span><span class="w">      </span>- <span class="l">my.dns.search.suffix</span><span class="w">
</span><span class="w">    </span><span class="nt">options</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ndots</span><span class="w">
</span><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2&#34;</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">edns0</span><span class="w">
</span></code></pre></div><h2 id="service-type">Service type</h2>
<p>Kubernetes 的 sevice 资源有四种类型，它决定了集群服务是如何暴露的，设定字段为 <code>.spec.type</code> ：</p>
<h3 id="clusterip">ClusterIP</h3>
<p><code>ClusterIP</code> 是默认和最常见的服务类型，成功创建资源后集群会自动分配服务的 IP 地址，这个 IP 地址和 Pod 网段是隔离的，它的网络通信依赖于 kube-proxy 组件。</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app.kubernetes.io/name</span><span class="p">:</span><span class="w"> </span><span class="l">proxy</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:stable</span><span class="w">
</span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http-web-svc</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-service</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app.kubernetes.io/name</span><span class="p">:</span><span class="w"> </span><span class="l">proxy</span><span class="w">
</span><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">name-of-service-port</span><span class="w">
</span><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l">http-web-svc</span><span class="w">
</span></code></pre></div><p>通常会将 Pod 或者 Deployment 资源加上 label ，然后使用 Service selector 来选中这些资源，这样的 Service 就可以将请求均衡发送到 Pod 集合中。</p>
<h3 id="nodeport">NodePort</h3>
<p><code>NodePort</code> 是 <code>ClusterIP</code> 的扩展类型。除了集群内部的服务 IP 地址，还会在集群中所有节点的对应端口进行监听，并代理到各自节点中的 Pod 中，实现外部访问集群内服务。</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-service</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app.kubernetes.io/name</span><span class="p">:</span><span class="w"> </span><span class="l">MyApp</span><span class="w">
</span><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">      </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="m">30007</span><span class="w">
</span></code></pre></div><p>在 yaml 文件中， port 是 Pod 暴露服务的端口， targetPort 是 Service 暴露服务的端口，两者可以保持一致，由 targetPort 跟随 port 即可， nodePort 可以显式指定，也可以不进行指定并由集群自动分配，通常采取第二种方式，来避免手动指定的端口和已有的服务产生冲突。自动分配的范围由 apiServer 中的 <code>--service-node-port-range</code> 参数指定，默认值是 <code>30000-32767</code> 。</p>
<h3 id="loadbalancer">LoadBalancer</h3>
<p><code>LoadBalancer</code> 是基于云厂商提供服务实现的服务类型，它基于 <code>NodePort</code> 进行扩展，和云厂商的负载均衡器绑定，是更高级的外部访问集群内服务实现方式。</p>
<p>可以认为这里 <code>NodePort</code> 是隐式实现的，并且云厂商还应该提供负载均衡器，它会对集群中所有节点代理，实现负载均衡。这样外部访问不再直接访问集群节点而是通过负载均衡器进行代理转发。</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-service</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app.kubernetes.io/name</span><span class="p">:</span><span class="w"> </span><span class="l">MyApp</span><span class="w">
</span><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">9376</span><span class="w">
</span><span class="w">  </span><span class="nt">clusterIP</span><span class="p">:</span><span class="w"> </span><span class="m">10.0.171.239</span><span class="w">
</span><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">LoadBalancer</span><span class="w">
</span><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">loadBalancer</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">ip</span><span class="p">:</span><span class="w"> </span><span class="m">192.0.2.127</span><span class="w">
</span></code></pre></div><p>在创建 LoadBalancer Service 时，通常只需要指定 <code>LoadBalancer</code> 作为 Service 类型即可，关于 port 的设置和 <code>nodePort</code> 类型相似。创建资源完成后会将负载均衡器信息报告在 status 中。</p>
<h3 id="externalname">ExternalName</h3>
<p><code>ExternalName</code> 是不直接关联 Pod 的服务类型，它实际是通过创建 CNAME 记录，来实现 Service 访问映射到其他域名。</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-service</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">prod</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ExternalName</span><span class="w">
</span><span class="w">  </span><span class="nt">externalName</span><span class="p">:</span><span class="w"> </span><span class="l">my.database.example.com</span><span class="w">
</span></code></pre></div><p>从官方文档中的实例可以非常明确这个服务类型的作用，它创建了一个内部服务，在提供给其他服务的同时，它本身并未在集群中运行，而这个服务只是在内部 DNS 创建 CNAME 记录，当其他服务访问时，实际上会通过 CNAME 访问到集群外部。也就是在访问 <code>my-service.prod.svc.cluster.local</code> 时，实际相当于访问 <code>my.database.example.com</code> 。</p>
<p>除了映射外部域名，它也经常用于将其他命名空间的服务映射为本地命名空间的服务，方便内部服务的域名访问规范。</p></article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
<script type="application/javascript" src='https://yuweizzz.github.io/js/toc.js'></script>
<link rel="stylesheet" href='https://yuweizzz.github.io/css/toc.css' />


  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://yuweizzz.github.io">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>
</body>

<script type="application/javascript" src="https://yuweizzz.github.io/js/github-style.js"></script>


<script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
<script type="text/javascript" src="https://yuweizzz.github.io/js/CustomLive2D.js"></script>


</html>